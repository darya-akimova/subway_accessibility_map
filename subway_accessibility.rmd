---
title: "The Inaccessible Subway: A Geospatial Analysis of the NYC Subway in R"
author: "Darya Akimova"
output: 
  html_document:
    toc: true
    toc_float:
      smooth_scroll: false
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```


# Introduction {.tabset .tabset-fade .tabset-pills}

## Background

TO EDIT

* NYC subway has a funding problem
* Link news articles 
* Plan set to update the system, but NYC has a history of bypassing upgrades to improve/increase assessibility
* Assessibility concerns usually bring to mind someone in a wheelchair, but an accessible system can help many:
  + parents with young children and strollers
  + people with temporary/not obvious injuries 
  + senior citizens 
  + someone who may have spent all day working on their feet


## Project Problems and Goals

TO EDIT

* Imitate maps seen here: [July 2018 NYC Comptroller Report ](https://comptroller.nyc.gov/reports/service-denied-accessibility-and-the-new-york-city-subway-system/)

Problem with report: NYC neighborhoods are areas that people can easily connect to, but they are very large in terms of area
Solution: Use the 2010 Census tracts instead - smaller

Another issue: Report focuses on the presence/absence of a subway station or ADA-accessible subway station, but no info on how many stations/routes are in the vicinity of a neighborhood
Solution: Mimic report, but also count unique route stops within a given geographical area 


## Data Science Skils Applied

TO EDIT

This project was initially sparked by the Data for Democracy NYC Accessibility project ( [ Project GitHub Repo](https://github.com/Data4Democracy/nyc-accessibility) ). I had been curious about geospatial analysis for a while, and this project was a great excuse to learn more. At the time when I started working on this, my main goal had been to make goegraphically realistic maps which would show exactly 

* Data cleaning - I had severely underestimated how messy and out-of-date the NYC Subway Entrances and Exits dataset was. It needed quite a lot of manual curation in the end to reach a ready state.
* Geospatial analysis in R - mapping, spatial joins, and other, using the `sf` package in R. As an aside, this [DataCamp course on the sf package, led by Zev Ross](https://www.datacamp.com/courses/spatial-analysis-in-r-with-sf-and-raster), was immensely helpful.


# Setup {.tabset .tabset-fade .tabset-pills}

## Packages

```{r packages, comment=NA}
library(tidyverse)
library(sf)
library(ggthemes)
```

Packages used:

* tidyverse - omnibus package for data import, wrangling, and cleaning 
* sf - geospatial analysis
* ggthemes - ggplot2 theme and palette add-on 


## Data Import

```{r data_import, comment=NA}
### shapefiles ###
# nyc map - broken up into 2010 census tracts #
nyc.census.map <- st_read("./data/nyct2010_18a/nyct2010.shp")
# nyc map - broken up into neighborhoods #
nyc.neigh.map <- st_read("./data/nynta_18d/nynta.shp")

### data ###
# subway entrances/exits #
subway.ent.exit <- read_csv("./data/2018_update/NYC_Transit_Subway_Entrance_And_Exit_Data.csv")
# subway line and route grouping and color info #
subway.by.line <- read_csv("./data/2018_update/nyc_subway_stations_grouped.csv")
# number of subway stations by route #
num.stat.by.rt.wiki <- read_csv("./data/2018_update/nyc_subway_num_stat_by_line.csv")
```

Data sources: 

* NYC Census Map shapefile: [NYC Department of City Planning Open Data Website](https://www1.nyc.gov/site/planning/data-maps/open-data/districts-download-metadata.page)
* NYC Neighborhood Tabulation Areas Map shapefile: [NYC Department of City Planning Open Data Website](https://www1.nyc.gov/site/planning/data-maps/open-data/dwn-nynta.page)
* Subway Entrances and Exits: [Open Data NY](https://data.ny.gov/Transportation/NYC-Transit-Subway-Entrance-And-Exit-Data/i9wp-a4ja)
* Subway by Line Info: Copied from the [NYC Subway Wikipedia Page](https://en.wikipedia.org/wiki/New_York_City_Subway)
* Number of Subway Stations by Route: Collected from each individual subway route page, such as this page for [the E subway service](https://en.wikipedia.org/wiki/New_York_City_Subway)


## Data Preview


```{r data_preview, comment=NA}
# set the theme
theme_set(theme_minimal())

# nyc census tracts map in blue
nyc.census.map %>% 
  ggplot() +
  geom_sf(color = "#1F77B4") +
  # nyc neighborhoods outlines overlaid in orange
  geom_sf(data = nyc.neigh.map, color = "#FF7F0E", size = 1, fill = NA)

# subway entrances/exit data:
glimpse(subway.ent.exit)
# subway summary data
glimpse(subway.by.line)
# num of station stops by route:
glimpse(num.stat.by.rt.wiki)
```

Preliminary to-do list:

* Remove Staten Island from the maps - the subway datasets do not include the Staten Island route
* `subway.ent.exit` - The entrances and exits dataset is very messy, needs cleaning and reogranization into a tidy format. However, it already contains geospatial coordinates for each station, which subway routes stop at that station, and ADA-Accessibility information
* `subway.by.line` - Needs to be tidied, with each subway route as its own row


# Preliminary analysis and light cleanup {.tabset .tabset-fade .tabset-pills}


## Cleaning ? 

First things first, cleanup the column names of the two subway info dataframes by converting the words to lower-case and by replacing empty spaces with `_`:

```{r comment=NA}
colnames(subway.ent.exit) <- colnames(subway.ent.exit) %>% 
  str_to_lower() %>% 
  str_replace_all(" ", "_")
colnames(subway.ent.exit)
colnames(subway.by.line) <- colnames(subway.by.line) %>% 
  str_to_lower() %>% 
  str_replace_all(" ", "_")
colnames(subway.by.line)
```

Much better! 


Now for some cleanup of the subway entrance/exit dataset:

* Create a unique station name column by combining the division. line, and station_name
* Gather the route names into one column and get rid of all of the missing values


```{r sub_line_tidy, comment=NA}
sub.line.tidy <- subway.by.line %>% 
  # separate the route names into their own columns (wide format)
  separate(lines, into = c(paste("route", 1:4, sep = "_")), remove = FALSE) %>% 
  # gather the separated route names into one column (long format)
  gather("route_num", "route_name", route_1:route_4) %>% 
  # remove extra rows created from extra columns where there fewer than 4 routes for that line
  filter(!is.na(route_name)) %>% 
  # unnecessary column: 
  select(-route_num) %>% 
  arrange(route_name)
glimpse(sub.line.tidy)


subway.ent.exit %>% 
  select(route1:route11) %>% 
  gather("route_num", "route_name") %>% 
  filter(!(is.na(route_name))) %>% 
  select(-route_num) %>% 
  distinct() %>% 
  anti_join(sub.line.tidy, by = "route_name")



length(unique(subway.ent.exit$station_name))
# NYC considers 472 to be the number of subway stations in the city, 424 if connected stations are considered single stations
nrow(subway.ent.exit %>% select(station_name, station_latitude:station_longitude) %>% distinct())

nrow(subway.ent.exit %>% select(division:station_name) %>% distinct())
sub.ext.cln <- subway.ent.exit %>% 
  mutate_at(vars(division:station_name), str_to_lower) %>% 
  unite("stat_name", division:station_name, sep = "_") %>% 
  mutate_at(vars(route1:route11), str_to_upper) %>% 
  distinct()
length(unique(sub.ext.cln$stat_name))
```

The number is a little off from the wikipedia page, another sign of how outdated this dataset is.


## Entrance Analysis

Does the entrance information provide anything interesting? 


```{r entrance_analysis, comment=NA}
sub.sml.test <- sub.ext.cln %>% 
  select(stat_name:station_longitude, entrance_latitude:entrance_longitude, route1:route11, entrance_type:entry, ada, free_crossover) %>%
  replace_na(
    list(
      route1 = "", route2 = "", route3 = "", route4 = "", 
      route5 = "", route6 = "", route7 = "", route8 = "", 
      route9 = "", route10 = "", route11 = ""
      )
    ) %>% 
  unite("routes", route1:route11, sep = "") %>% 
  distinct()
table(sub.sml.test$free_crossover)

sub.sml.test %>% 
  select(stat_name, free_crossover) %>% 
  distinct() %>% 
  group_by(stat_name) %>% 
  count() %>% 
  filter(n > 1)
sub.sml.test %>% 
  select(stat_name, free_crossover, ada) %>% 
  distinct() %>% 
  group_by(ada, free_crossover) %>% 
  count()

percent_ada <- sub.sml.test %>% 
  group_by(stat_name) %>% 
  summarize(
    num_entry = n(),
    num_ada = sum(ada),
    percent_ada = round(num_ada * 100 / num_entry, 2)
  )
percent_ada %>% 
  ggplot(aes(percent_ada)) +
  geom_histogram(bins = 50) +
  xlab("Percent of Exits that are ADA = TRUE")
table(percent_ada$percent_ada)
table(sub.sml.test$entrance_type)
```


It seems that all of the exits/entrances are either ADA-accessible or none of them are, which is strange because many of the entrances are `Stairs`. More likely, the ADA rating is given to each station, but each entrance/exit is not scored. A typical accessible routes are elevators and escalators, although I believe an elevator is required for a station to be fully ADA-accessible. (source?)


```{r comment=NA}
sub.sml.test %>% 
  group_by(station_latitude, station_longitude) %>% 
  summarize(
    num_entry = n(),
    num_ada = sum(ada),
    percent_ada = round(num_ada * 100 / num_entry, 2)
  ) %>% 
  {table(.$percent_ada)}
sub.sml.test %>% 
  group_by(entrance_type, ada) %>% 
  count() %>% 
  ggplot(aes(entrance_type, n, fill = ada)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  scale_fill_tableau()
sub.sml.test %>% 
  group_by(entrance_type, ada) %>% 
  count() %>% 
  ggplot(aes(entrance_type, n, fill = ada)) +
  geom_bar(stat = "identity", position = "fill") +
  theme_minimal() +
  scale_fill_tableau()
```


## More cleaning

```{r comment=NA}
# note that the sta
length(unique(subway.ent.exit$station_name))
nrow(subway.ent.exit %>% select(station_name, station_latitude:station_longitude) %>% distinct())
nrow(subway.ent.exit %>% select(division:station_name) %>% distinct())
sub.ext.cln %>% 
  select(stat_name, ada, ada_notes) %>% 
  filter(!(is.na(ada_notes))) %>% 
  distinct()

sub.stat.coord <- sub.ext.cln %>% 
  select(stat_name:station_longitude) %>% 
  distinct() %>% 
  group_by(stat_name) %>% 
  summarize(
    avg_stat_lat = mean(station_latitude),
    avg_stat_long = mean(station_longitude)
  )

sub.ext.sml <- sub.ext.cln %>% 
  select(stat_name, route1:route11, ada, ada_notes) %>% 
  inner_join(sub.stat.coord, by = "stat_name") %>% 
  distinct() %>% 
  gather("route_num", "route_name", route1:route11) %>% 
  filter(!is.na(route_name)) %>% 
  select(-route_num) %>% 
  distinct()
glimpse(sub.ext.sml)
sapply(sub.ext.sml, anyNA)
length(unique(sub.ext.sml$stat_name))
sub.ext.sml %>% 
  select(stat_name, route_name) %>% 
  distinct() %>% 
  nrow()

sub.ext.sml %>% 
  select(stat_name, ada, ada_notes) %>% 
  distinct() %>% 
  filter(!(is.na(ada_notes)))
sub.ext.sml %>% 
  filter(stat_name == "ind_8 avenue_world trade center")

sub.ext.sml %>%
  filter(str_detect(stat_name, "ind")) %>% 
  separate(stat_name, into = c("division", "line", "station_name"), sep = "_") %>% 
  {table(.$line)}
sub.ext.sml %>%
  filter(str_detect(stat_name, "irt")) %>% 
  separate(stat_name, into = c("division", "line", "station_name"), sep = "_") %>% 
  {table(.$line)}
sub.ext.sml %>% 
  filter(route_name == "G") %>% 
  ggplot(aes(avg_stat_long, avg_stat_lat)) + 
  geom_point() + 
  coord_quickmap()
# G train missing station stops between Smith 9th St and Church Ave, where the service 
# should add those in - follows the F train here, get the slice of stations: 
sub.ext.sml %>% 
  filter(route_name == "F") %>% 
  arrange(avg_stat_lat) %>% 
  filter(avg_stat_lat > 40.62976 & avg_stat_lat < 40.68030)
sub.ext.sml %>% 
  filter(route_name == "F") %>% 
  arrange(avg_stat_lat) %>% 
  filter(avg_stat_lat > 40.62976 & avg_stat_lat < 40.68030 & str_detect(stat_name, "4")) %>% 
  ggplot(aes(avg_stat_long, avg_stat_lat)) +
  geom_point()
sub.ext.sml %>% 
  filter(route_name == "F") %>% 
  arrange(avg_stat_lat) %>% 
  filter(avg_stat_lat > 40.62976 & avg_stat_lat < 40.68030) %>% 
  ggplot(aes(avg_stat_long, avg_stat_lat)) +
  geom_point() +
  coord_quickmap()

# G train is considered IND - grab that 4th ave station
sub.ext.sml.rt.fix <- sub.ext.sml %>% 
  bind_rows(
    sub.ext.sml %>% 
      filter(route_name == "F") %>% 
      arrange(avg_stat_lat) %>% 
      filter(avg_stat_lat > 40.63612 & avg_stat_lat < 40.67358 & str_detect(stat_name, "ind")) %>% 
      mutate(route_name = "G")
)

nyc.map.4boro <- nyc.census.map %>%  
  filter(BoroName != "Staten Island") %>% 
  mutate(BoroName = str_to_lower(BoroName))
nyc.map.4boro %>% filter(str_detect(NTAName, "park") | str_detect(NTAName, "Airport")) %>% ggplot() +geom_sf()
nyc.map.4boro %>% 
  filter(!(str_detect(NTAName, "park") | str_detect(NTAName, "Airport"))) %>% 
  ggplot(aes(Shape_Area)) +
  geom_histogram()
nyc.map.4boro.crs.geo <- st_transform(nyc.map.4boro, crs = "+init=epsg:4326")

sub.ext.sml.rt.fix %>% 
  filter(route_name == "F" | route_name == "G") %>% 
  ggplot(aes(avg_stat_long, avg_stat_lat, color = route_name)) +
  geom_point(size = 2, alpha = 0.8) +
  coord_quickmap()
nyc.map.4boro.crs.geo %>% 
  ggplot() +
  geom_sf() +
  geom_point(
    data = sub.ext.sml.rt.fix %>% 
      filter(route_name == "F" | route_name == "G"),
    aes(avg_stat_long, avg_stat_lat, color = route_name),
    size = 2, alpha = 0.8
    ) +
  theme_minimal()
nyc.map.4boro.crs.geo %>% 
  ggplot() +
  geom_sf() +
  geom_point(
    data = sub.ext.sml.rt.fix %>% 
      filter(route_name == "F"),
    aes(avg_stat_long, avg_stat_lat, color = route_name),
    size = 2, alpha = 0.8
    ) +
  theme_minimal()




sub.ext.sml.rt.fix %>% 
  select(stat_name, ada, ada_notes) %>% 
  distinct() %>% 
  filter(!(is.na(ada_notes)))


# GS and S routes are redundant - refer to the same thing, the grand central shuttle between times square and grand central

# solution - filter out "S" route, change GS to ada = FALSE
```

To check:

* ind_8 avenue_50th st / TRUE / Southbound Only - Leave as ada = TRUE (no changes)
* ind_8 avenue_world trade center / TRUE / Construction - ada = TRUE for E only 
* ind_archer av_sutphin blvd-archer av - jfk / TRUE / Check - ada = TRUE according to wikipedia page (no change)
* bmt_broadway_49th st / TRUE / Northbound Only - Leave as ada = TRUE (no change)
* bmt_broadway_times square-42nd st / TRUE / Shuttle not ADA - set S to ada = FALSE
* bmt_broadway_union square / TRUE / Lex not ADA - set 4/5/6 to ada = FALSE   
* bmt_canarsie_union square / TRUE / Lex not ADA - same as above      
* ind_concourse_kingsbridge rd / FALSE / in planning - switch to TRUE because it is complete      
* irt_lexington_23rd st / FALSE In Planning - switch to TRUE because it is complete
* irt_lexington_brooklyn bridge-city hall / TRUE / J Z not ADA - set J/Z to ada = FALSE
* irt_lexington_canal st / TRUE / Bway Nass not ADA - Only set 6 ada  = TRUE
* irt_pelham_hunts point av / FALSE / in planning - complete, set ada = TRUE     
* ind_queens boulevard_forest hills-71st av / FALSE / in planning - complete, set ada = TRUE

Note: This dataset has not been updated for the BMT Broadway Line / Yellow Line / NQRW train changes, namely it still includes the old Q route that went into Queens, and does not include the 3 new stations that were opened along 2nd Ave in Manhattan, all of which are ADA-Accessible.


## ADA fixes and hitting a wall

```{r comment = NA}
sub.ext.ada.updt <- sub.ext.sml.rt.fix %>% 
  # change world trade center station ada
  mutate(ada = ifelse((stat_name == "ind_8 avenue_world trade center" & route_name != "E"), FALSE, ada)) %>% 
  # change times square shuttle ada, filter out extra "S" route
  filter(route_name != "S") %>% 
  mutate(ada = ifelse(route_name == "GS", FALSE, ada)) %>% 
  # change 4/5/6 at union square to ada = FALSE
  mutate(ada = ifelse(
      (
        (stat_name == "bmt_broadway_union square" | stat_name == "bmt_canarsie_union square") &
        (route_name == "4" | route_name == "5" | route_name == "6")
      ), FALSE, ada)) %>% 
  # change kingsbridge rd ada = TRUE
  mutate(ada = ifelse(stat_name == "ind_concourse_kingsbridge rd", TRUE, ada)) %>% 
  # change Lex / 23rd St stop to TRUE
  mutate(ada = ifelse(stat_name == "irt_lexington_23rd st", TRUE, ada)) %>% 
  # change J/Z at Brooklyn Bridge / City Hall to ada = FALSE
  mutate(ada = ifelse(
    (stat_name == "irt_lexington_brooklyn bridge-city hall" & (route_name == "J" | route_name == "Z")),
    FALSE, ada)) %>% 
  # change irt_lexington_canal st to ada = TRUE for 6 train only
  mutate(ada = ifelse(
    (stat_name == "irt_lexington_canal st" & route_name != "6"), FALSE, ada
  )) %>% 
  # change rt 6 hunts point av to ada = TRUE
  mutate(ada = ifelse(stat_name == "irt_pelham_hunts point av", TRUE, ada)) %>% 
  # convert the forst hills / 71st ave station to ada = TRUE for all lines
  mutate(ada = ifelse(stat_name == "ind_queens boulevard_forest hills-71st av", TRUE, ada)) %>% 
  select(-ada_notes) %>% 
  distinct()
dim(sub.ext.sml.rt.fix)
dim(sub.ext.ada.updt)
table(sub.ext.ada.updt$ada)

sub.ext.ada.updt %>% 
  filter(route_name == "GS")
sub.ext.ada.updt %>% 
  filter(route_name == "S")
percent.ada.updt <- sub.ext.ada.updt %>% 
  group_by(stat_name) %>% 
  summarize(
    num_entry = n(),
    num_ada = sum(ada),
    percent_ada = round(num_ada * 100 / num_entry, 2)
  )
hist(percent.ada.updt$percent_ada)
table(percent.ada.updt$percent_ada)
percent.ada.updt %>% 
  group_by(num_entry) %>% 
  count() %>% 
  ggplot(aes(num_entry, n)) +
  geom_bar(stat = "identity")
percent.ada.updt %>%
  group_by(num_ada) %>% 
  count() %>% 
  ggplot(aes(num_ada, n)) +
  geom_bar(stat = "identity")
```


This process brought up an additional problem - lines are assigned to routes that they do not belong in, and there are extra stops (probably because some stations are connected and technically the entrances/exits apply to those routes as well).


```{r comment= NA}
stat.by.route.count <- sub.ext.ada.updt %>% 
  group_by(route_name) %>% 
  count()  
stat.by.route.count %>%  
  ggplot(aes(route_name, n)) +
  geom_bar(stat = "identity")
stat.route.join <- stat.by.route.count %>% 
  full_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(route_name != "W")
stat.route.join %>% 
  ggplot(aes(num_stations_norm, n)) +
  geom_abline(intercept = 0, slope = 1, size = 1, alpha = 0.8) +
  geom_point(size = 2, alpha = 0.8) +
  xlab("stat num by route (wiki)") +
  ylab("stat num by route (count)")
stat.route.join %>% 
  filter(num_stations_norm == n)
```

TO EDIT

Nearly all, with the exception of the H Shuttle route, had more subway stations assigned to them than expected. The extra stations could not be accounted for by different service patterns (for example local late-night service for some routes). From exploring the dataset, it seems that the source of the problems were: 


* Station duplicates, or the station name differed based on the route, but all of the routes that stopped at that station were still assigned.
* The dataset being simply outdated - no changes made to account for service changes over the years.
* Separate stations connected by underground tunnels being listed as one station, with all routes servicing both stations. For example, Times Square / 42nd St is linked by a tunnel to the Port Authority / 42nd St stops, but these are distinct stations, served by distinct subway routes. However, all of the subway routes that serve both stations are assigned to both stations.

At this point, the options, as I saw them, were: 

Solution 1: Import a dataset form the NYC Open Data website with updated station coordinates (SOURCE) and try to merge the two datasets 
Problems: Subway station names repeat, would probably have to still do a lot of manual data cleaning and validation to make sure the stations merge as expected. Also, if the subway route information is out of date, likely the ADA-status of stations is also outdated as well (this assumption turns out to be true in the end).

Solution 2: Manually go through route-by-route to make sure that the information is accurate and station duplicates are removed
Problems: Tedious manual work, and likely easy to mess up. Will have to manually add-in new 2nd Ave Q-train stations, along with some others probably.


# Cleaning each route {.tabset .tabset-fade .tabset-pills}


## Reasoning and Resources

I chose Solution 2 because, from working with other NYC subway-related datasets, I've learned that subway station name formatting tends to be inconsistent between datasets and a number of stations have duplicate names. Going line by line turned out to be less tedious than I expected in the end, because routes in the same primary trunk line tended to have the same issues that needed fixing (removing double stations, for example). Also, most of the subway stations were accurately labeled according to the primary trunk line 3-letter code (irt, ind, and so on), which helped narrow down the list of stations. It's not very pretty, but it got the job done.

These tools helped quite a bit:

NYC Subway Map
Route list

Disclaimer: The subway routes change considerably between normal, rush-hour, late-night, and weekend service. For sanity, I based the route/station assignments on the wikipedia counts for most lines, except for the B, which seems to have been based on weekday rush-hour service patterns for most trains, and on the routes on the MTA website list. I did not include late-night service changes (even though some routes stop at more stations).


## Going by lowest number of stations


Starting slow, with the shuttles:

```{r shuttle_update, comment=NA}
num.stat.by.rt.wiki %>% 
  filter(route_name == "GS")
sub.ext.ada.updt %>% 
  filter(route_name == "GS") %>% 
  arrange(stat_name)
sub.stat.num.updt <- sub.ext.ada.updt %>% 
  filter(!(route_name == "GS" & (str_detect(stat_name, "flushing") | str_detect(stat_name, "lexington"))))
num.stat.by.rt.wiki %>% 
  filter(route_name == "FS")
stat.by.route.count %>% 
  filter(route_name == "FS")
sub.stat.num.updt %>% 
  filter(route_name == "FS") %>% 
  arrange(avg_stat_lat)
# remove the ind and irt stations - those are the extras
sub.stat.num.updt <- sub.stat.num.updt %>% 
  filter(!(route_name == "FS" & (str_detect(stat_name, "irt") | str_detect(stat_name, "ind"))))
sub.stat.num.updt %>% 
  filter(route_name == "FS")
sub.stat.num.updt %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>% 
  filter(num_stations_norm == min(num_stations_norm))
```


G and Z, both with 21 stations each, are next. I had initially wondered if maybe there are duplicates based on station lat/long pairs, and if I could get away with using the unique coordinates. Unfortunately that did not turn out to be the 


```{r G_and_Z_update, comment=NA}
### G route fix ###
sub.line.tidy %>% 
  filter(route_name == "G")
sub.stat.num.updt %>% 
  filter(route_name == "G") %>% 
  select(avg_stat_lat, avg_stat_long) %>% 
  distinct() %>% 
  nrow()
sub.stat.num.updt.G <- sub.stat.num.updt %>% 
  filter(route_name != "G") %>% 
  bind_rows(
    sub.stat.num.updt %>% 
      filter(route_name == "G" & str_detect(stat_name, "ind") & stat_name != "ind_queens boulevard_23rd st-ely av")
    )
sub.stat.num.updt.G %>% 
  filter(route_name == "G") %>% 
  nrow()

### Z route fix ###
sub.line.tidy %>% 
  filter(route_name == "Z")
sub.stat.num.updt.Z <- sub.stat.num.updt.G %>% 
  filter(route_name != "Z") %>% 
  bind_rows(
    sub.stat.num.updt.G %>% 
      filter(route_name == "Z" & str_detect(stat_name, "bmt") & stat_name != "bmt_broadway_canal st (ul)") %>% 
      # Z train was not included on the list of trains at broadway junction stop in Queens (was A/C/J/L)
      bind_rows(
        sub.stat.num.updt.G %>% 
          filter(str_detect(stat_name, "broadway junction")) %>% 
          mutate(route_name = "Z") %>% 
          distinct()
        ) %>% 
      # Z train was also not listed on Alabama Ave stop in Queens (was J only)
      bind_rows(
        sub.stat.num.updt.G %>% 
          filter(str_detect(stat_name, "alabama")) %>% 
          mutate(route_name = "Z")
      ) %>% 
      # add back in the jamaica center and jfk airport stops that were filtered out
      bind_rows(
        sub.stat.num.updt.G %>% 
          filter(route_name == "Z" & avg_stat_long > -73.82829)
        )
    )
sub.stat.num.updt.Z %>% 
  filter(route_name == "Z") %>% 
  nrow()

## Next fix targets ##
sub.stat.num.updt.Z %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>% 
  filter(num_stations_norm == min(num_stations_norm))

# 7 Train, goal: 22
sub.line.tidy %>% 
  filter(route_name == "7")
sub.stat.num.updt.7 <-  sub.stat.num.updt.Z %>%
  filter(route_name != "7") %>% 
  bind_rows(
    sub.stat.num.updt.Z %>% 
      filter(route_name == "7" & str_detect(stat_name, "irt")) %>% 
      # eliminate station copies
      filter(
        # times square extra
        stat_name != "irt_42nd st shuttle_times square" &
        # grand central extra
          stat_name != "irt_42nd st shuttle_grand central" &
          stat_name != "irt_lexington_grand central-42nd st"
          ) %>% 
      mutate(ada = ifelse(stat_name == "irt_flushing_45 rd-court house sq", TRUE, ada))
  )
sub.stat.num.updt.7 %>% 
  filter(route_name == "7") %>% 
  nrow()
# E train, goal: 22
sub.line.tidy %>% 
  filter(route_name == "E")
sub.stat.num.updt.E <- sub.stat.num.updt.7 %>% 
  filter(route_name != "E") %>% 
  bind_rows(
    sub.stat.num.updt.7 %>% 
      filter(route_name == "E" & str_detect(stat_name, "ind")) %>% 
      filter(stat_name != "ind_8 avenue_chambers st") %>% 
      mutate(ada = ifelse(stat_name == "ind_archer av_jamaica-van wyck", TRUE, ada)) %>% 
      bind_rows(
        # add in Briarwood station (a late night station)
        sub.stat.num.updt.7 %>% 
          filter(str_detect(stat_name, "briarwood")) %>% 
          mutate(route_name = "E")
        )
    )

## Next fix targets ##
sub.stat.num.updt.E %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>% 
  filter(num_stations_norm == min(num_stations_norm))

# L train, goal: 24
sub.line.tidy %>% 
  filter(route_name == "L")
sub.stat.num.updt.L <-  sub.stat.num.updt.E %>% 
  filter(route_name != "L") %>% 
  bind_rows(
    sub.stat.num.updt.E %>% 
      filter(route_name == "L" & str_detect(stat_name, "bmt")) %>% 
      filter(stat_name != "bmt_broadway_union square") %>% 
      mutate(ada = ifelse(stat_name == "bmt_canarsie_wilson av", TRUE, ada)) %>% 
      # add back in broadway junction
      bind_rows(
        sub.stat.num.updt.E %>% 
          filter(str_detect(stat_name, "broadway junction") & route_name == "L")
        )
    )
sub.stat.num.updt.L %>% 
  filter(route_name == "L") %>% 
  nrow()
## Next fix targets ##
sub.stat.num.updt.L %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>% 
  filter(num_stations_norm == min(num_stations_norm))

# B line: target - 37 - will include rush hour stations 
sub.line.tidy %>% 
  filter(route_name == "B")
sub.stat.num.updt.B <- sub.stat.num.updt.L %>% 
  filter(route_name != "B") %>% 
  bind_rows(
    sub.stat.num.updt.L %>% 
      filter(route_name == "B" & (str_detect(stat_name, "bmt") | str_detect(stat_name, "ind"))) %>% 
      # convert non-ada stations to those that are ada = TRUE now
      mutate(
        ada = ifelse((
          stat_name == "bmt_brighton_kings highway" | 
            stat_name == "ind_6 avenue_broadway-lafayette st" | 
            stat_name == "ind_8 avenue_125th st"
          ), TRUE, ada)
        ) %>% 
      # stations to exclude atlantic ave /barclays duplicates 
      # and stops between barclays and brighton where B does not stop
      filter(!(avg_stat_lat > 40.60867 & avg_stat_lat < 40.63508)) %>% 
      filter(!(
        stat_name %in% c(
          "bmt_broadway_34th st", "bmt_brighton_parkside av", 
          "bmt_4 avenue_pacific st", "bmt_brighton_atlantic av", 
          "bmt_brighton_av u", "bmt_brighton_neck rd", 
          "bmt_brighton_beverly rd", "bmt_brighton_cortelyou rd"
          )
        ))
    )
dim(sub.stat.num.updt.B)

## Next fix targets ##
sub.stat.num.updt.B %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B") %>% 
  filter(num_stations_norm == min(num_stations_norm))

# 4 train, target is 28 - exclude late night service
sub.stat.num.updt.4 <- sub.stat.num.updt.B %>% 
  filter(route_name != "4") %>% 
  bind_rows(
    sub.stat.num.updt.B %>% 
      filter(route_name == "4" & str_detect(stat_name, "irt")) %>% 
      filter(!(
        stat_name %in% c(
          "irt_flushing_grand central-42nd st", "irt_42nd st shuttle_grand central", 
          "irt_clark_fulton st", "irt_clark_borough hall"
          )
        )) %>% 
      mutate(ada = ifelse(stat_name == "irt_lexington_fulton st", TRUE, ada))
    )
```


## Switch to primary trunk lines


```{r by_trunk_lines, comment=NA}
# J train, goal: 30
sub.stat.num.updt.J <- sub.stat.num.updt.4 %>% 
  filter(route_name != "J") %>% 
  bind_rows(
    sub.stat.num.updt.4 %>% 
      filter(route_name == "J" & str_detect(stat_name, "bmt")) %>%
      filter(stat_name != "bmt_broadway_canal st (ul)") %>% 
      bind_rows(
        sub.stat.num.updt.4 %>% 
        filter(route_name == "J" & avg_stat_long > -73.82829)
      ) %>% 
      bind_rows(
        sub.stat.num.updt.4 %>% 
              filter(str_detect(stat_name, "broadway junction") & route_name == "J")
      ) %>% 
      mutate(ada = ifelse(stat_name == "bmt_nassau_fulton st", TRUE, ada))
    )

sub.stat.num.updt.J %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")

# route A, goal: 44 stations
sub.stat.num.updt.A <- sub.stat.num.updt.J %>% 
  filter(route_name != "A") %>% 
  bind_rows(
    sub.stat.num.updt.J %>% 
      filter(route_name == "A" & str_detect(stat_name, "ind")) %>%
      filter(!(
        stat_name %in% c(
          "ind_8 avenue_world trade center", "ind_8 avenue_broadway-nassau", 
          "ind_fulton_franklin av", "ind_fulton_kingston-throop",
          "ind_fulton_ralph av", "ind_fulton_rockaway av",
          "ind_fulton_liberty av", "ind_fulton_van siclen av", 
          "ind_fulton_shepherd av"
          )
        )) %>% 
      bind_rows(
        sub.stat.num.updt.J %>% 
          filter(str_detect(stat_name, "fulton st") & route_name == "4") %>% 
          mutate(route_name = "A")
      ) %>% 
      mutate(ada = ifelse(stat_name %in% c("ind_8 avenue_125th st", "ind_rockaway_far rockaway-mott av", "ind_rockaway_aqueduct racetrack", "ind_fulton_jay st - borough hall", "ind_fulton_utica av", "ind_liberty_lefferts blvd"), TRUE, ada)) %>% 
      bind_rows(
        sub.stat.num.updt.J %>% 
          filter(route_name == "H" & !(str_detect(stat_name, "broad channel"))) %>% 
          mutate(route_name = "A")
      )
    )
nrow(sub.stat.num.updt.A)

sub.stat.num.updt.A %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# C next, goal: 40 stations
sub.stat.num.updt.C <- sub.stat.num.updt.A %>% 
  filter(route_name != "C") %>% 
  bind_rows(
    sub.stat.num.updt.A %>% 
      filter(route_name == "C" & str_detect(stat_name, "ind")) %>% 
      filter(!(stat_name %in% c("ind_8 avenue_broadway-nassau", "ind_8 avenue_world trade center"))) %>% 
      bind_rows(
            sub.stat.num.updt.A %>% 
              filter(str_detect(stat_name, "fulton st") & route_name == "A") %>% 
              mutate(route_name = "C")
        ) %>%
      mutate(ada = ifelse(stat_name %in% c("ind_8 avenue_125th st", "ind_fulton_jay st - borough hall", "ind_fulton_utica av"), TRUE, ada))
)
sub.stat.num.updt.C %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# route 5, goal: 45 
sub.stat.num.updt.5 <- sub.stat.num.updt.C %>% 
  filter(route_name != "5") %>% 
  bind_rows(
    sub.stat.num.updt.C %>% 
      filter(route_name == "5" & str_detect(stat_name, "irt")) %>% 
      filter(!(
        stat_name %in% c(
          "irt_clark_borough hall", "irt_clark_fulton st", 
          "irt_flushing_grand central-42nd st", "irt_42nd st shuttle_grand central", 
          "irt_white plains road_wakefield-241st st"
          )
        )) %>%
      mutate(ada = ifelse(
        stat_name %in% c("irt_lexington_fulton st", "irt_white plains road_east 180th st", "irt_white plains road_gun hill rd"), TRUE, ada
        ))
    )
sub.stat.num.updt.5 %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")

# Next: route 6, goal = 38
sub.stat.num.updt.6 <- sub.stat.num.updt.5 %>% 
  filter(route_name != "6") %>% 
  bind_rows(
    sub.stat.num.updt.5 %>% 
      filter(route_name == "6" & str_detect(stat_name, "irt")) %>% 
      filter(!(stat_name %in% c("irt_flushing_grand central-42nd st", "irt_42nd st shuttle_grand central"))) %>% 
      mutate(ada = ifelse(stat_name %in% c("irt_lexington_bleecker st"), TRUE, ada))
    )
sub.stat.num.updt.6 %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# Next: route D, goal: 36
sub.stat.num.updt.D <- sub.stat.num.updt.6 %>% 
  filter(route_name != "D") %>% 
  bind_rows(
    sub.stat.num.updt.6 %>% 
      filter(route_name == "D" & (str_detect(stat_name, "ind") | str_detect(stat_name, "bmt"))) %>% 
      filter(!(
        stat_name %in% c(
          "bmt_broadway_34th st", "bmt_4 avenue_pacific st", 
          "bmt_brighton_atlantic av", "bmt_sea beach_new utrecht av", 
          "bmt_brighton_stillwell av")
        )) %>% 
      bind_rows(
        sub.stat.num.updt.6 %>% 
          filter(str_detect(stat_name, "4 avenue_36")) %>% 
          mutate(route_name = "D") %>% 
          distinct()
        ) %>% 
      mutate(ada = ifelse(
        stat_name %in% c("ind_8 avenue_125th st", "ind_6 avenue_broadway-lafayette st", "bmt_west end_bay parkway"), TRUE, ada)
        )
    )

sub.stat.num.updt.D %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")

# Next: route F, goal: 45
sub.stat.num.updt.F <- sub.stat.num.updt.D %>% 
  filter(route_name != "F") %>% 
  bind_rows(
    sub.stat.num.updt.D %>% 
      filter(route_name == "F" & (str_detect(stat_name, "ind") | str_detect(stat_name, "bmt"))) %>% 
      filter(!(
        stat_name %in% c(
          "bmt_broadway_34th st", "bmt_canarsie_6th av", 
          "bmt_nassau_essex st", "bmt_broadway_lawrence st", 
          "bmt_4 avenue_9th st", "bmt_brighton_stillwell av", 
          "bmt_brighton_west 8th st"
          )
        )) %>% 
      mutate(ada = ifelse(stat_name %in% c("ind_6 avenue_broadway-lafayette st", "ind_fulton_jay st - borough hall"), TRUE, ada))
    )
nrow(sub.stat.num.updt.F %>% filter(route_name == "F"))
sub.stat.num.updt.F %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# Next: route M, goal: 36
sub.stat.num.updt.M <- sub.stat.num.updt.F %>% 
  filter(route_name != "M") %>% 
  bind_rows(
    sub.stat.num.updt.F %>% 
      filter(route_name == "M" & (str_detect(stat_name, "ind") | str_detect(stat_name, "bmt"))) %>% 
      filter(!(stat_name %in% c("bmt_broadway_34th st", "bmt_canarsie_6th av", "bmt_nassau_essex st"))) %>% 
      mutate(ada = ifelse(stat_name %in% c("ind_6 avenue_broadway-lafayette st"), TRUE, ada))
    )
sub.stat.num.updt.M %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# Next: route 1, goal: 38
sub.stat.num.updt.1 <- sub.stat.num.updt.M %>% 
  filter(route_name != "1") %>% 
  bind_rows(
    sub.stat.num.updt.M %>% 
      filter(route_name == "1" & str_detect(stat_name, "irt")) %>%
      filter(!(stat_name %in% c("irt_42nd st shuttle_times square", "irt_clark_park place"))) %>% 
      # add in the re-opened WTC Cortlandt station (coord from wikipedia)
      bind_rows(
        tibble(
          stat_name = "irt_broadway-7th ave_wtc cortlandt", ada = TRUE, 
          avg_stat_lat = 40.7115, avg_stat_long = -74.012, route_name = "1")
        ) %>% 
      mutate(
        ada = ifelse(
          stat_name %in% c(
            "irt_broadway-7th ave_dyckman st", "irt_broadway-7th ave_168th st"
            ), 
          TRUE, ada))
    )
sub.stat.num.updt.1 %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# Next: route 2, goal: 49 or 52?
sub.stat.num.updt.2 <- sub.stat.num.updt.1 %>% 
  filter(route_name != "2") %>% 
  bind_rows(
    sub.stat.num.updt.1 %>% 
      filter(route_name == "2" & str_detect(stat_name, "irt")) %>% 
      filter(!(
        stat_name %in% c(
          "irt_42nd st shuttle_times square", "irt_lexington_fulton st",
          "irt_lexington_borough hall"
          )
        )) %>% 
      mutate(
        ada = ifelse(stat_name %in% c(
          "irt_white plains road_gun hill rd", "irt_white plains road_east 180th st",
          "irt_clark_fulton st"
          ), TRUE, ada)
        )
    )
sub.stat.num.updt.2 %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")

#Next: route 3, goal: 34
sub.stat.num.updt.3 <- sub.stat.num.updt.2 %>% 
  filter(route_name != "3") %>% 
  bind_rows(
    sub.stat.num.updt.2 %>% 
      filter(route_name == "3" & str_detect(stat_name, "irt")) %>% 
      filter(!(stat_name %in% c(
        "irt_42nd st shuttle_times square", "irt_lexington_fulton st", "irt_lexington_borough hall"
        ))) %>%
      mutate(ada = ifelse(stat_name %in% c("irt_clark_fulton st"), TRUE, ada))
    )
sub.stat.num.updt.3 %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# What I've been dreading, R goal = 45
sub.stat.num.updt.R <- sub.stat.num.updt.3 %>% 
  filter(route_name != "R") %>% 
  bind_rows(
    sub.stat.num.updt.3 %>% 
      filter(route_name == "R" & (str_detect(stat_name, "bmt") | str_detect(stat_name, "ind"))) %>% 
      filter(!(stat_name %in% c(
        "ind_6 avenue_smith-9th st", "bmt_4 avenue_pacific st", 
        "bmt_brighton_atlantic av", "ind_fulton_jay st - borough hall", 
        "bmt_nassau_canal st", "bmt_canarsie_union square", "ind_6 avenue_34th st", "ind_8 avenue_42nd st"
        ))) %>% 
      mutate(ada = ifelse(stat_name %in% c("bmt_broadway_lawrence st", "bmt_broadway_cortlandt st"), TRUE, ada))
    )
sub.stat.num.updt.R %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# Next: route N, num stations - 32
sub.stat.num.updt.N <- sub.stat.num.updt.R %>% 
  filter(route_name != "N") %>% 
  bind_rows(
    sub.stat.num.updt.R %>% 
      filter(route_name == "N" & str_detect(stat_name, "bmt")) %>% 
      filter(!(stat_name %in% c(
        "bmt_brighton_stillwell av", "bmt_west end_62nd st", 
        "bmt_brighton_atlantic av", "bmt_4 avenue_pacific st", 
        "bmt_nassau_canal st", "bmt_canarsie_union square"
        ))) %>% 
      bind_rows(
        sub.stat.num.updt.R %>% filter(route_name == "N" & str_detect(stat_name, "queensboro"))
      )
    )
sub.stat.num.updt.N %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")

num.stat.by.rt.wiki %>% 
  filter(route_name == "W")

sub.stat.num.updt.W <- sub.stat.num.updt.N %>% 
  bind_rows(
    sub.stat.num.updt.N %>% 
      filter(route_name == "N" & avg_stat_lat > 40.68367) %>% 
      bind_rows(
        sub.stat.num.updt.N %>% 
          filter(route_name == "R") %>% 
          filter(avg_stat_lat > 40.69410 & avg_stat_lat < 40.71952)
        ) %>% 
      mutate(route_name = "W")
    )
sub.stat.num.updt.W %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# last route: Q, with 29 stations

sub.stat.num.updt.final <- sub.stat.num.updt.W %>% 
  filter(route_name != "Q") %>% 
  bind_rows(
    sub.stat.num.updt.W %>% 
      filter(route_name == "Q" & !str_detect(stat_name, "astoria") & str_detect(stat_name, "bmt")) %>%
      bind_rows(
        tibble(
          stat_name = c("ind_2 avenue_72nd st", "ind_2 avenue_86th st", "ind_2 avenue_96th st"), 
          ada = rep(TRUE, 3), 
          avg_stat_lat = c(40.768889, 40.777861, 40.7841), 
          avg_stat_long = c(-73.958333, -73.95175, -73.9472), 
          route_name = rep("Q", 3)
          )
        ) %>% 
      bind_rows(
        sub.stat.num.updt.W %>% 
          filter(stat_name == "ind_63rd street_lexington av") %>% 
          mutate(route_name = "Q")
      ) %>% 
      filter(!(stat_name %in% c(
        "bmt_broadway_5th av", "bmt_broadway_lexington av", 
        "bmt_broadway_49th st", "bmt_canarsie_union square", 
        "bmt_nassau_canal st", "bmt_4 avenue_pacific st", 
        "bmt_brighton_atlantic av", "bmt_coney island_stillwell av", 
        "bmt_coney island_west 8th st"
        ))) %>%
      mutate(ada = ifelse(stat_name %in% c("bmt_brighton_av h", "bmt_brighton_kings highway"), TRUE, ada))
    )
sub.stat.num.updt.final %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.rt.wiki, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
```


# Analysis and Visualization

```{r comment=NA}
nyc.map.4boro <- nyc.census.map %>%  
  filter(BoroName != "Staten Island") %>% 
  mutate(BoroName = str_to_lower(BoroName))
tract.cent <- st_centroid(nyc.map.4boro)

sub.cln.sf <- st_as_sf(sub.stat.num.updt.final, coords = c("avg_stat_long", "avg_stat_lat"), crs = 4326)
sub.sf.nyc.crs <- st_transform(sub.cln.sf, crs = st_crs(nyc.map.4boro))

plot(st_geometry(nyc.map.4boro), col = "grey", border = "white")
plot(sub.sf.nyc.crs, pch = 16, cex = 0.25, col = "#D55E00", add = TRUE)

sub.boro <- st_join(sub.sf.nyc.crs, nyc.map.4boro)
```


```{r}

sub.boro.nogeo <- st_set_geometry(sub.boro, NULL) %>% 
  as_tibble() %>% 
  select(stat_name:route_name, BoroName:BoroCT2010, NTAName, Shape_Area)
stat.by.route <- sub.boro.nogeo %>% 
  group_by(route_name) %>% 
  summarize(
    total_stat = n(),
    num_ada = sum(ada),
    per_ada = num_ada * 100 / total_stat
  ) %>% 
  mutate(
    rt_mod = ifelse(
      route_name == "GS" | route_name == "FS" | route_name == "H",
      "S",
      route_name
      )
    ) %>% 
  left_join(sub.line.tidy, by = c("rt_mod" = "route_name")) %>% 
  arrange(primary_trunk_line, route_name) 
stat.by.route$rt_order <- factor(stat.by.route$route_name, levels = stat.by.route$route_name)

subway.by.line <- subway.by.line %>% 
  arrange(primary_trunk_line)

stat.by.route %>% 
  ggplot(aes(rt_order, total_stat, fill = primary_trunk_line)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = subway.by.line$hexadecimal, name = "Line") +
  ylab("Total Number of Stations") +
  xlab("Subway Route")
stat.by.route %>% 
  ggplot(aes(rt_order, num_ada, fill = primary_trunk_line)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = subway.by.line$hexadecimal, name = "Line") +
  ylab("Number of ADA Stations") +
  xlab("Subway Route")
stat.by.route %>% 
  ggplot(aes(rt_order, per_ada, fill = primary_trunk_line)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = subway.by.line$hexadecimal, name = "Line") +
  ylab("Percent of Stations that are ADA") +
  xlab("Subway Route")

stat.by.route <- stat.by.route %>% 
  arrange(total_stat) %>% 
  mutate(total_stat_order = factor(route_name, levels = route_name))
 
stat.by.route %>% 
  ggplot(aes(total_stat_order, total_stat)) +
  geom_segment(aes(x = total_stat_order, xend = total_stat_order, y = num_ada, yend = total_stat), size = 1, alpha= 0.5, color = "#56B4E9") +
  geom_point(size = 3, color = "#0072B2") +
  geom_point(aes(total_stat_order, num_ada), size = 3, color = "#56B4E9") +
  xlab("Route Name") +
  coord_flip()

stat.by.route %>% 
  ggplot(aes(total_stat, num_ada, color = primary_trunk_line)) +
  geom_abline(slope = 1, intercept = 0, alpha = 0.5, size = 1.5) +
  geom_point(size = 3) +
  scale_color_manual(values = subway.by.line$hexadecimal, name = "Line") +
  xlab("Total Number of Stations") +
  ylab("Number of ADA Stations") +
  theme_minimal()
stat.by.route %>% 
  ggplot(aes(total_stat, per_ada, color = primary_trunk_line)) +
  geom_point(size = 3) +
  scale_color_manual(values = subway.by.line$hexadecimal, name = "Line") +
  xlab("Total Number of Stations") +
  ylab("Percent of Stations that are ADA") +
  theme_minimal()
stat.by.route %>% 
  ggplot(aes(total_stat, per_ada, color = primary_trunk_line, label = route_name)) +
  geom_point(size = 3) +
  scale_color_manual(values = subway.by.line$hexadecimal, name = "Line") +
  geom_text(hjust = 0, vjust = 0, check_overlap = TRUE, nudge_y = 1.5) +
  xlab("Total Number of Stations") +
  ylab("Percent of Stations that are ADA") +
  theme_minimal()
```


```{r boro_plots, comment=NA}
sub.boro.nogeo

boro.stat.count <- sub.boro.nogeo %>%
  group_by(BoroName) %>% 
  summarize(
    tot_stat = n(),
    ada_stat = sum(ada),
    ada_percent = ada_stat * 100 / tot_stat
    )
  
boro.stat.count %>% 
  select(-ada_percent) %>% 
  gather("stat_type", "num_stat", tot_stat:ada_stat) %>% 
  ggplot(aes(BoroName, num_stat, fill = stat_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_tableau()
boro.stat.count %>% 
  ggplot(aes(BoroName, ada_percent, fill = BoroName)) + 
  geom_bar(stat= "identity") +
  scale_fill_tableau()
neigh.stat.count <- sub.boro.nogeo %>% 
  group_by(BoroName, NTAName) %>% 
  summarize(
    tot_stat = n(),
    ada_stat = sum(ada),
    ada_percent = ada_stat * 100 / tot_stat
    )
neigh.stat.count %>% 
  ggplot(aes(x = BoroName, y = ada_percent, color = BoroName)) +
  geom_jitter(size = 2, alpha = 0.8, width = 0.25) +
  scale_color_tableau()

```




```{r}
nyc.neigh.4boro <- nyc.neigh.map %>% 
  filter(BoroName != "Staten Island")
plot(st_geometry(nyc.neigh.4boro))
nyc.neigh.stat.count <- st_join(sub.sf.nyc.crs, nyc.neigh.4boro) %>% 
 st_set_geometry(NULL) %>% 
  group_by(BoroName, NTAName) %>% 
  summarize(
    tot_stat = n(),
    ada_stat = sum(ada),
    percent_ada = ada_stat * 100 / tot_stat
  ) %>% 
  ungroup()
glimpse(nyc.neigh.stat.count)
nyc.neigh.stat.count %>% 
  ggplot(aes(BoroName, tot_stat, color = BoroName)) +
  geom_jitter(size = 2, alpha = 0.8, width = 0.25) +
  scale_color_tableau()
data_summary <- function(x) {
   m <- mean(x)
   ymin <- ifelse(m - sd(x) > 0, m - sd(x), 0)
   ymax <- m + sd(x)
   return(c(y=m,ymin=ymin,ymax=ymax))
}
nyc.neigh.stat.count %>% 
  ggplot(aes(BoroName, tot_stat, color = BoroName, fill = BoroName)) +
  geom_violin() +
  stat_summary(fun.data = data_summary, color = "black", alpha = 0.8) +
  scale_color_tableau() +
  scale_fill_tableau() +
  xlab("Borough") +
  ylab("Subway Stations per Neighborhood")
nyc.neigh.stat.count %>% 
  ggplot(aes(BoroName, ada_stat, color = BoroName, fill = BoroName)) +
  geom_violin() +
  stat_summary(fun.data = data_summary, color = "black", alpha = 0.8) +
  scale_color_tableau() +
  scale_fill_tableau() +
  xlab("Borough") +
  ylab("Subway Stations per Neighborhood")

nyc.neigh.4boro.count <- nyc.neigh.4boro %>% 
  full_join(
    nyc.neigh.stat.count %>% 
      select(-BoroName),
    by = "NTAName"
    )
nyc.neigh.4boro.count %>% 
  ggplot() +
  geom_sf(aes(fill = tot_stat)) 
nyc.neigh.count.prep <- nyc.neigh.4boro.count %>% 
  mutate(
    color_group = ifelse(
      str_detect(NTAName, "park"), "Park", ifelse(
        str_detect(NTAName, "Airport"), "Airport", ifelse(
          !(str_detect(NTAName, "park") | str_detect(NTAName, "Airport")) & is.na(tot_stat), "No stations", ifelse(
            !(str_detect(NTAName, "park") | str_detect(NTAName, "Airport")) & tot_stat > 0 & ada_stat < 1, "No accessible stations", ifelse(
              !(str_detect(NTAName, "park") | str_detect(NTAName, "Airport")) & tot_stat > 0 & ada_stat > 0, "At least one accessible station", "Don't know"
              )
            )
          )
        )
      )
    )
table(nyc.neigh.count.prep$color_group)
nyc.neigh.count.prep %>% 
  ggplot() +
  geom_sf(aes(fill = color_group), color = "#BFBFBF") +
  scale_fill_manual(values = c("grey30", "#0072B2", "#E69F00", "#999999", "#bae4b3")) +
  geom_sf(data = sub.sf.nyc.crs, color = "#BFBFBF", fill = "black", size = 1, pch = 21)
nyc.neigh.count.prep %>% 
  ggplot() +
  geom_sf(aes(fill = tot_stat), color = "#BFBFBF") +
  scale_fill_viridis_c(option = "D")
nyc.neigh.count.prep %>% 
  ggplot() +
  geom_sf(aes(fill = ada_stat), color = "#BFBFBF") +
  scale_fill_viridis_c(option = "D")
nyc.neigh.count.prep$ada_per_breaks <- cut(nyc.neigh.count.prep$percent_ada, breaks = seq(0, 100, 20))
nyc.neigh.count.prep %>% 
  ggplot() +
  geom_sf(aes(fill = ada_per_breaks), color = "#BFBFBF") +
  scale_fill_manual(values = c("#c7e9b4", "#7fcdbb", "#41b6c4", "#2c7fb8", "#253494"), na.value = "gray50")
summary(nyc.neigh.count.prep$percent_ada)
```



```{r census_tract_buffer, comment=NA}
tract.cent <- st_centroid(nyc.map.4boro)
nyc.map.4boro %>% 
  ggplot() +
  geom_sf(color = "#BFBFBF") +
  geom_sf(data = tract.cent, size = 1, color = "#4E79A7")
# half-mile buffer
tract.cent.halfmi.buff <- st_buffer(tract.cent, dist = 2640)
nyc.map.4boro %>% 
  ggplot() +
  geom_sf(color = "#BFBFBF") +
  geom_sf(data = tract.cent.halfmi.buff, alpha = 0.2, color = "#F28E2B") +
  geom_sf(data = tract.cent, size = 1, color = "#4E79A7")
#example
nyc.map.4boro %>% 
  ggplot() +
  geom_sf(color = "#BFBFBF") +
  geom_sf(data = tract.cent.halfmi.buff %>% filter(BoroCT2010 == 1009800 | BoroCT2010 == 1018400 ), alpha = 0.8, color = "#F28E2B", fill = "#F28E2B") +
  geom_sf(data = sub.sf.nyc.crs, color = "black", size = 1)



sub.buffer.join <- st_join(sub.sf.nyc.crs, tract.cent.halfmi.buff) %>% 
  st_set_geometry(NULL)

sub.buffer.join %>% 
  filter(BoroCT2010 == 1018400)

nyc.map.4boro.test <- nyc.map.4boro %>% 
  full_join(
    sub.buffer.join %>% 
      group_by(BoroCT2010) %>% 
      summarize(
        tot_stat = n(),
        ada_stat = sum(ada)
      ) %>% 
      ungroup(),
    by = "BoroCT2010"
    )
length(unique(sub.buffer.join$BoroCT2010))
length(unique(nyc.map.4boro$BoroCT2010))
nyc.map.4boro.test %>% 
  filter(BoroCT2010 == 1009800 | BoroCT2010 == 1018400)

nyc.map.4boro.test %>% 
  ggplot() +
  geom_sf(aes(fill = tot_stat)) +
  scale_fill_viridis_c(option = "A") +
  geom_sf(data = sub.sf.nyc.crs, color = "white", size = 1)
nyc.map.4boro.test %>% 
    mutate(
    color_group = ifelse(
      str_detect(NTAName, "park"), "Park", ifelse(
        str_detect(NTAName, "Airport"), "Airport", ifelse(
          !(str_detect(NTAName, "park") | str_detect(NTAName, "Airport")) & is.na(tot_stat), "No stations", ifelse(
            !(str_detect(NTAName, "park") | str_detect(NTAName, "Airport")) & tot_stat > 0 & ada_stat < 1, "No accessible stations", ifelse(
              !(str_detect(NTAName, "park") | str_detect(NTAName, "Airport")) & tot_stat > 0 & ada_stat > 0, "At least one accessible station", "Don't know"
              )
            )
          )
        )
      )
    ) %>% 
  ggplot() +
  geom_sf(aes(fill = color_group)) +
  scale_fill_manual(values = c("grey30", "#0072B2", "#E69F00", "#999999", "#bae4b3")) +
  #geom_sf(data = sub.sf.nyc.crs, color = "#BFBFBF", fill = "black", size = 1, pch = 21)
  geom_sf(data = sub.sf.nyc.crs, color = "#BFBFBF", size = 1)

nyc.map.4boro.test %>% 
  mutate(ada_stat = ifelse(ada_stat == 0, NA, ada_stat)) %>% 
  ggplot() +
  geom_sf(aes(fill = ada_stat)) +
  scale_fill_viridis_c(option = "A") +
  geom_sf(data = sub.sf.nyc.crs, color = "white", size = 1)


### separate the spatial join by borough ###

sub.sf.nyc.crs.boro <- sub.sf.nyc.crs %>% 
  inner_join(
    sub.boro %>% 
      st_set_geometry(NULL) %>% 
      as_tibble() %>% 
      select(stat_name, BoroName) %>% 
      distinct(),
    by = "stat_name"
  )

sub.join.borolim <- sub.sf.nyc.crs.boro %>% 
  # manhattan
  filter(BoroName == "manhattan") %>% 
  st_join(
    tract.cent.halfmi.buff %>% 
      filter(BoroName == "manhattan")
    ) %>% 
  st_set_geometry(NULL) %>% 
  bind_rows(
    # bronx
    sub.sf.nyc.crs.boro %>% 
      filter(BoroName == "bronx") %>% 
      st_join(
        tract.cent.halfmi.buff %>% 
          filter(BoroName == "bronx")
        ) %>% 
      st_set_geometry(NULL)
    ) %>% 
  bind_rows(
    # brooklyn and queens together
    sub.sf.nyc.crs.boro %>% 
      filter(BoroName == "brooklyn" | BoroName == "queens") %>% 
      st_join(
        tract.cent.halfmi.buff %>% 
          filter(BoroName == "brooklyn" | BoroName == "queens")
        ) %>% 
      st_set_geometry(NULL)
    )

nyc.map.4boro.buff.join <- nyc.map.4boro %>% 
  full_join(
    sub.join.borolim %>% 
      group_by(BoroCT2010) %>% 
      summarize(
        tot_stat = n(),
        ada_stat = sum(ada)
      ) %>% 
      ungroup(),
    by = "BoroCT2010"
    )


nyc.map.4boro.buff.join %>% 
  ggplot() +
  geom_sf(aes(fill = tot_stat)) +
  scale_fill_viridis_c(option = "A") +
  geom_sf(data = sub.sf.nyc.crs, color = "white", size = 1)
nyc.map.4boro.buff.join %>% 
    mutate(
    color_group = ifelse(
      str_detect(NTAName, "park"), "Park", ifelse(
        str_detect(NTAName, "Airport"), "Airport", ifelse(
          !(str_detect(NTAName, "park") | str_detect(NTAName, "Airport")) & is.na(tot_stat), "No stations", ifelse(
            !(str_detect(NTAName, "park") | str_detect(NTAName, "Airport")) & tot_stat > 0 & ada_stat < 1, "No accessible stations", ifelse(
              !(str_detect(NTAName, "park") | str_detect(NTAName, "Airport")) & tot_stat > 0 & ada_stat > 0, "At least one accessible station", "Don't know"
              )
            )
          )
        )
      )
    ) %>% 
  ggplot() +
  geom_sf(aes(fill = color_group)) +
  scale_fill_manual(values = c("grey30", "#0072B2", "#E69F00", "#999999", "#bae4b3")) +
  #geom_sf(data = sub.sf.nyc.crs, color = "#BFBFBF", fill = "black", size = 1, pch = 21)
  geom_sf(data = sub.sf.nyc.crs, color = "#BFBFBF", size = 1)

nyc.map.4boro.buff.join %>% 
  mutate(ada_stat = ifelse(ada_stat == 0, NA, ada_stat)) %>% 
  ggplot() +
  geom_sf(aes(fill = ada_stat)) +
  scale_fill_viridis_c(option = "A") +
  geom_sf(data = sub.sf.nyc.crs, color = "white", size = 1)

```


# Session Info

```{r session_info, comment=NA}
sessionInfo()
```

