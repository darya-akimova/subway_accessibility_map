---
title: "underserviced_areas"
author: "Darya Akimova"
date: "August 23, 2018"
output: 
  html_document:
    toc: true
    toc_float:
      smooth_scroll: false
    number_sections: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

Main question to address: What areas of NYC are under-serviced by ADA accessible stations?

Plan: Somehow randomly "sample" locations in the NYC territory in (longitude, latitude) unit pairs and then calculate distance from that point to the nearest ada-certified (accessible) subway station. Normalize to nearest (accessible or not accessible) station? 

Need:
- Data for which stations are ADA-accessible
- Data for station locations (longitude, latitude)
- Some way to sample the territory of NYC (it's an odd shape)

# Setup

## Packages

```{r packages, comment=NA}
library(tidyverse)
library(sf)
library(ggthemes)
```


## Data

```{r data, comment=NA}
nyc.census.map <- st_read("./data/nyct2010_18a/nyct2010.shp")
subway.ent.exit <- read_csv("./data/2018_update/NYC_Transit_Subway_Entrance_And_Exit_Data.csv")
subway.by.line <- read_csv("./data/2018_update/nyc_subway_stations_grouped.csv")
```


```{r preview, comment=NA}
plot(nyc.census.map$geometry)
# subway entrances/exit data:
glimpse(subway.ent.exit)
# subway summary data
glimpse(subway.by.line)
```

First things first, cleanup the column names of the two subway info dataframes by converting the words to lower-case and by replacing empty spaces with `_`:

```{r comment=NA}
colnames(subway.ent.exit) <- colnames(subway.ent.exit) %>% 
  str_to_lower() %>% 
  str_replace_all(" ", "_")
colnames(subway.ent.exit)
colnames(subway.by.line) <- colnames(subway.by.line) %>% 
  str_to_lower() %>% 
  str_replace_all(" ", "_")
colnames(subway.by.line)
```

Much better! 

Now for some cleanup of the subway entrance/exit dataset:

* Create a unique station name column by combining the division. line, and station_name
* Gather the route names into one column and get rid of all of the missing values


```{r}
sub.line.tidy <- subway.by.line %>% 
  separate(lines, into = c(paste("route", 1:4, sep = "_")), remove = FALSE) %>% 
  gather("route_num", "route_name", route_1:route_4) %>% 
  filter(!is.na(route_name)) %>% 
  select(-route_num) %>% 
  arrange(route_name)
glimpse(sub.line.tidy)


subway.ent.exit %>% 
  select(route1:route11) %>% 
  gather("route_num", "route_name") %>% 
  filter(!(is.na(route_name))) %>% 
  select(-route_num) %>% 
  distinct() %>% 
  anti_join(sub.line.tidy, by = "route_name")



length(unique(subway.ent.exit$station_name))
nrow(subway.ent.exit %>% select(station_name, station_latitude:station_longitude) %>% distinct())
nrow(subway.ent.exit %>% select(division:station_name) %>% distinct())
sub.ext.cln <- subway.ent.exit %>% 
  mutate_at(vars(division:station_name), str_to_lower) %>% 
  unite("stat_name", division:station_name, sep = "_") %>% 
  mutate_at(vars(route1:route11), str_to_upper) %>% 
  distinct()


  



```



```{r}
sub.sml.test <- sub.ext.cln %>% 
  select(stat_name:station_longitude, entrance_latitude:entrance_longitude, route1:route11, entrance_type:entry, ada, free_crossover) %>%
  replace_na(
    list(
      route1 = "", route2 = "", route3 = "", route4 = "", 
      route5 = "", route6 = "", route7 = "", route8 = "", 
      route9 = "", route10 = "", route11 = ""
      )
    ) %>% 
  unite("routes", route1:route11, sep = "") %>% 
  distinct()
table(sub.sml.test$free_crossover)

sub.sml.test %>% 
  select(stat_name, free_crossover) %>% 
  distinct() %>% 
  group_by(stat_name) %>% 
  count() %>% 
  filter(n > 1)
sub.sml.test %>% 
  select(stat_name, free_crossover) %>% 
  distinct() %>% 
  filter(!free_crossover)
sub.sml.test %>% 
  select(stat_name, free_crossover, ada) %>% 
  distinct() %>% 
  group_by(ada, free_crossover) %>% 
  count()
subway.ent.exit %>% 
  filter(ada & !free_crossover)

percent_ada <- sub.sml.test %>% 
  group_by(stat_name) %>% 
  summarize(
    num_entry = n(),
    num_ada = sum(ada),
    percent_ada = round(num_ada * 100 / num_entry, 2)
  )
hist(percent_ada$percent_ada)
table(percent_ada$percent_ada)
table(sub.sml.test$entrance_type)

sub.sml.test %>% 
  group_by(station_latitude, station_longitude) %>% 
  summarize(
    num_entry = n(),
    num_ada = sum(ada),
    percent_ada = round(num_ada * 100 / num_entry, 2)
  ) %>% 
  {table(.$percent_ada)}
sub.sml.test %>% 
  group_by(station_latitude, station_longitude) %>% 
  summarize(
    num_entry = n(),
    num_free_cross = sum(free_crossover),
    percent_free_cross = round(num_free_cross * 100 / num_entry, 2)
  ) %>% 
  {table(.$percent_free_cross)}
sub.sml.test %>% 
  group_by(entrance_type, ada) %>% 
  count() %>% 
  ggplot(aes(entrance_type, n, fill = ada)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  scale_fill_tableau()
sub.sml.test %>% 
  group_by(entrance_type, ada) %>% 
  count() %>% 
  ggplot(aes(entrance_type, n, fill = ada)) +
  geom_bar(stat = "identity", position = "fill") +
  theme_minimal() +
  scale_fill_tableau()
sub.sml.test %>% 
  group_by(entrance_type, free_crossover) %>% 
  count() %>% 
  ggplot(aes(entrance_type, n, fill = free_crossover)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  scale_fill_tableau()
```


```{r comment=NA}
# note that the sta
length(unique(subway.ent.exit$station_name))
nrow(subway.ent.exit %>% select(station_name, station_latitude:station_longitude) %>% distinct())
nrow(subway.ent.exit %>% select(division:station_name) %>% distinct())
sub.ext.sml <- sub.ext.cln %>% 
  select(stat_name:station_longitude, route1:route11, ada) %>% 
  distinct() %>% 
  gather("route_num", "route_name", route1:route11) %>% 
  filter(!is.na(route_name)) %>% 
  select(-route_num) %>% 
  distinct()
glimpse(sub.ext.sml)
sapply(sub.ext.sml, anyNA)
```






```{r subway_boro}
set.seed(2018)
nyc311_loc <- read_csv(file = "./data/unique_nyc_2015_311.csv") %>%
  distinct() %>% 
  sample_frac(0.25, replace = FALSE)
glimpse(nyc311_loc)

sub.boro <- sub.ext.sml %>% 
  mutate(join_key = paste(round(station_latitude, 2), round(station_longitude, 2), sep = "_")) %>% 
  left_join(nyc311_loc %>% 
              mutate(latitude = round(Latitude, 2),
                     longitude = round(Longitude, 2),
                     join_key = paste(latitude, longitude, sep = "_")) %>% 
              distinct(), by = "join_key") %>% 
  # cleanup 
  select(stat_name:route_name, Borough) %>% 
  distinct() %>% 
  rename("borough" = Borough) %>% 
  mutate(borough = str_to_lower(borough))
glimpse(sub.boro)

ggplot(sub.boro, aes(station_longitude, station_latitude, color = borough)) +
  geom_point(size = 1, alpha = 0.5)

ggplot(sub.boro, aes(station_longitude, station_latitude, color = borough)) +
  geom_point(size = 1, alpha = 0.5) +
  facet_wrap(~borough, nrow = 2)

# some straight forward manual elimination: 
sub.boro %>% 
  filter(borough == "manhattan" & station_latitude < 40.7) %>% 
  ggplot(aes(station_longitude, station_latitude, color = borough)) +
  geom_point(size = 1, alpha = 0.5) +
  ylim(40.6, 40.9) +
  xlim(-74.05, -73.9)
sub.boro %>% 
  filter(borough == "bronx" & station_latitude < 40.8) %>% 
  ggplot(aes(station_longitude, station_latitude, color = borough)) +
  geom_point(size = 1, alpha = 0.5) +
  ylim(40.75, 40.91) +
  xlim(-73.93, -73.82)
sub.boro <- sub.boro %>% 
  filter(!((borough == "manhattan" & station_latitude < 40.7) | (borough == "bronx" & station_latitude < 40.8))) 

ggplot(sub.boro, aes(station_longitude, station_latitude, color = borough)) +
  geom_point(size = 1, alpha = 0.5)

sub.mult.boro <- sub.boro %>% 
  select(stat_name:station_longitude, borough) %>% 
  distinct() %>% 
  group_by(stat_name, station_latitude, station_longitude) %>% 
  count() %>% 
  filter(n > 1) %>% 
  arrange(stat_name)
glimpse(sub.mult.boro)

testing <- sub.boro %>% 
  select(stat_name:station_longitude, borough, route_name) %>% 
  distinct() %>% 
  group_by(stat_name, station_latitude, station_longitude, route_name) %>% 
  count() %>% 
  filter(n > 1) %>% 
  arrange(stat_name)
sub.mult.boro %>% anti_join(testing, by = "stat_name")
testing %>% anti_join(sub.mult.boro, by = "stat_name")

sub.test <- sub.boro %>% 
  filter(stat_name %in% sub.mult.boro$stat_name) %>% 
  select(stat_name:station_longitude, borough) %>% 
  distinct()
sub.test2 <- sub.boro %>% 
  filter(stat_name %in% sub.mult.boro$stat_name) %>% 
  select(stat_name:station_longitude, route_name, borough) %>% 
  arrange(stat_name, route_name, borough) %>% 
  distinct()

sub.boro <- sub.boro %>% 
  filter(
    !(
      (stat_name == "ind_6 avenue_east broadway" & borough == "brooklyn") | 
      (stat_name == "ind_63rd street_roosevelt island" & borough == "queens") |
      (stat_name == "bmt_broadway jamaica_crescent st" & borough == "queens") |
      (stat_name == "bmt_broadway jamaica_cypress hills" & borough == "queens") |
      (stat_name == "bmt_broadway jamaica_elderts lane-75th st" & borough == "brooklyn") |
      (stat_name == "irt_broadway-7th ave_207th st" & borough == "bronx") |
      # techincally, this station is considred part of Manhattan, but it's not on Manhattan island itself
      (stat_name == "irt_broadway-7th ave_marble hill-225th st" & borough == "manhattan") |
      (stat_name == "bmt_canarsie_halsey st" & borough == "brooklyn") |
      (stat_name == "bmt_canarsie_jefferson st" & borough == "queens") |
      (stat_name == "bmt_canarsie_myrtle av" & borough == "queens") |
      (stat_name == "bmt_canarsie_wilson av" & borough == "queens") |
      (stat_name == "ind_crosstown_21st st" & borough == "brooklyn") |
      (stat_name == "irt_flushing_hunters point" & borough == "brooklyn") |
      (stat_name == "irt_flushing_vernon blvd-jackson av" & borough == "brooklyn") |
      (stat_name == "ind_fulton_euclid av" & borough == "queens") |
      (stat_name == "irt_jerome_138th st" & borough == "manhattan") |
      (stat_name == "irt_jerome_149th st-grand concourse" & borough == "manhattan") |
      (stat_name == "ind_liberty_80th st-hudson st" & borough == "brooklyn") |
      (stat_name == "ind_liberty_grant av" & borough == "queens") |
      (stat_name == "bmt_myrtle_forest av" & borough == "brooklyn") |
      (stat_name == "bmt_myrtle_seneca av" & borough == "brooklyn") |
      (stat_name == "irt_pelham_138th st-3rd ave" & borough == "manhattan")
      )
    )
sub.boro %>% 
  select(stat_name:station_longitude, borough) %>% 
  distinct() %>% 
  group_by(stat_name, station_latitude, station_longitude) %>% 
  count() %>% 
  filter(n > 1) %>% 
  arrange(stat_name)
route.mult <- sub.boro %>% 
  group_by(station_latitude, station_longitude, route_name) %>% 
  count() %>% 
  filter(n > 1) %>% 
  unite("stat_key", station_latitude:station_longitude, sep = "_", remove = FALSE) %>% 
  inner_join(
    sub.boro %>% 
      unite("stat_key", station_latitude:station_longitude, sep = "_"),
    by = "stat_key"
  ) %>% 
  filter(route_name.x == route_name.y) %>% 
  arrange(station_latitude, station_longitude, route_name.x, stat_name)
unique(route.mult$stat_name)


identical(
  sub.boro %>% filter(stat_name == "bmt_brighton_west 8th st") %>% select(-stat_name),
  sub.boro %>% filter(stat_name == "bmt_coney island_west 8th st") %>% select(-stat_name)
)
identical(
  sub.boro %>% filter(stat_name == "bmt_brighton_stillwell av") %>% select(-stat_name),
  sub.boro %>% filter(stat_name == "bmt_coney island_stillwell av") %>% select(-stat_name) 
)
identical(
  sub.boro %>% filter(stat_name == "bmt_4 avenue_atlantic av-barclays ctr") %>% select(-stat_name),
  sub.boro %>% filter(stat_name == "bmt_4 avenue_pacific st") %>% select(-stat_name)
  )
sub.boro <- sub.boro %>% 
  filter(
    !(
      stat_name == "bmt_coney island_west 8th st" |
      stat_name == "bmt_coney island_stillwell av" |
      stat_name == "bmt_4 avenue_pacific st"
    )
  )
```


```{r}
stat.by.route <- sub.boro %>% 
  group_by(route_name) %>% 
  summarize(
    total_stat = n(),
    num_ada = sum(ada),
    per_ada = num_ada * 100 / total_stat
  ) %>% 
  mutate(
    rt_mod = ifelse(
      route_name == "GS" | route_name == "FS" | route_name == "H",
      "S",
      route_name
      )
    ) %>% 
  left_join(sub.line.tidy, by = c("rt_mod" = "route_name")) %>% 
  arrange(primary_trunk_line, route_name) 
stat.by.route$rt_order <- factor(stat.by.route$route_name, levels = stat.by.route$route_name)

subway.by.line <- subway.by.line %>% 
  arrange(primary_trunk_line)

stat.by.route %>% 
  ggplot(aes(rt_order, total_stat, fill = primary_trunk_line)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = subway.by.line$hexadecimal)
stat.by.route %>% 
  ggplot(aes(rt_order, num_ada, fill = primary_trunk_line)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = subway.by.line$hexadecimal)
stat.by.route %>% 
  ggplot(aes(rt_order, per_ada, fill = primary_trunk_line)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = subway.by.line$hexadecimal)
stat.by.route %>% 
  ggplot(aes(total_stat, num_ada, color = primary_trunk_line)) +
  geom_abline(slope = 1, intercept = 0, alpha = 0.5, size = 1.5) +
  geom_point(size = 3) +
  scale_color_manual(values = subway.by.line$hexadecimal)
stat.by.route %>% 
  ggplot(aes(total_stat, per_ada, color = primary_trunk_line)) +
  geom_point(size = 3) +
  scale_color_manual(values = subway.by.line$hexadecimal)
stat.by.route %>% 
  ggplot(aes(total_stat, per_ada, color = primary_trunk_line, label = route_name)) +
  geom_point(size = 3) +
  scale_color_manual(values = subway.by.line$hexadecimal) +
  geom_text(hjust = 0, vjust = 0, check_overlap = TRUE, nudge_y = 1.5)
```



```{r dist_calc}
nyc.map.4boro <- nyc.census.map %>%  
  filter(BoroName != "Staten Island") %>% 
  mutate(BoroName = str_to_lower(BoroName))
tract.cent <- st_centroid(nyc.map.4boro)
plot(st_geometry(nyc.map.4boro), col = "grey", border = "white")
plot(tract.cent, pch = 16, cex = 0.25, col = "#D55E00", add = TRUE)



sub.small <- sample_n(sub.boro, size = 20)
test <- st_as_sf(sub.boro, coords = c("station_longitude", "station_latitude"), crs = 4326)
test2 <- st_transform(test, crs = st_crs(nyc.map.4boro))

plot(st_geometry(nyc.map.4boro), col = "grey", border = "white")
plot(test2, pch = 16, cex = 1, col = "#D55E00", add = TRUE)


test.10 <- tract.cent %>% 
  select(BoroCT2010, BoroName)
test.10$geometry <- NULL
test.10 <- test.10 %>% 
  as_tibble()

man_dist_test <- test.10 %>% 
  filter(BoroName == "manhattan") %>% 
  bind_cols(
    tract.cent %>% 
      filter(BoroName == "manhattan") %>% 
      st_distance(
        test2 %>% 
        filter(borough == "manhattan")
        ) %>% 
      unclass() %>% 
      as_tibble()
  ) %>% 
  gather("station", "ft_dist", -c(BoroCT2010, BoroName)) %>% 
  group_by(BoroCT2010, BoroName) %>% 
  top_n(-5, ft_dist) %>% 
  mutate(mile_dist = ft_dist / 5280) %>% 
  summarise(
    mean5_all = mean(mile_dist),
    med5_all = median(mile_dist)
    ) %>% 
  ungroup()
man_dist_test %>% 
  gather("measure", "distance", mean5_all:med5_all) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 15) +
  facet_wrap(~ measure)

nyc.map.4boro %>% 
  inner_join(man_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med5_all)) +
  scale_fill_viridis_c(option = "D")




bronx_dist_test <- test.10 %>% 
  filter(BoroName == "bronx") %>% 
  bind_cols(
    tract.cent %>% 
      filter(BoroName == "bronx") %>% 
      st_distance(
        test2 %>% 
        filter(borough == "bronx")
        ) %>% 
      unclass() %>% 
      as_tibble()
  ) %>% 
  gather("station", "ft_dist", -c(BoroCT2010, BoroName)) %>% 
  group_by(BoroCT2010, BoroName) %>% 
  top_n(-5, ft_dist) %>% 
  mutate(mile_dist = ft_dist / 5280) %>% 
  summarise(
    mean5_all = mean(mile_dist),
    med5_all = median(mile_dist)
    ) %>% 
  ungroup()

bronx_dist_test %>% 
  gather("measure", "distance", mean5_all:med5_all) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 15) +
  facet_wrap(~ measure)


nyc.map.4boro %>% 
  inner_join(bronx_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med5_all)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(bronx_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean5_all)) +
  scale_fill_viridis_c(option = "B")




brkl_queen_dist_test <- test.10 %>% 
  filter(BoroName == "brooklyn" | BoroName == "queens") %>% 
  bind_cols(
    tract.cent %>% 
      filter(BoroName == "brooklyn" | BoroName == "queens") %>% 
      st_distance(
        test2 %>% 
        filter(borough == "brooklyn" | borough == "queens")
        ) %>% 
      unclass() %>% 
      as_tibble()
  ) %>% 
  gather("station", "ft_dist", -c(BoroCT2010, BoroName)) %>% 
  group_by(BoroCT2010, BoroName) %>% 
  top_n(-5, ft_dist) %>% 
  mutate(mile_dist = ft_dist / 5280) %>% 
  summarise(
    mean5_all = mean(mile_dist),
    med5_all = median(mile_dist)
    ) %>% 
  ungroup()

brkl_queen_dist_test %>% 
  gather("measure", "distance", mean5_all:med5_all) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 15) +
  facet_wrap(~ measure)


nyc.map.4boro %>% 
  inner_join(brkl_queen_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med5_all)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(brkl_queen_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean5_all)) +
  scale_fill_viridis_c(option = "B")


all_dist_test <- man_dist_test %>% 
  bind_rows(bronx_dist_test) %>% 
  bind_rows(brkl_queen_dist_test)

nyc.map.4boro %>% 
  inner_join(all_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med5_all)) +
  scale_fill_viridis_c(option = "B")
  
nyc.map.4boro %>% 
  inner_join(all_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean5_all)) +
  scale_fill_viridis_c(option = "B")

ggplot(nyc.map.4boro) +
  geom_sf(aes(fill = BoroName)) 


tract.cent_test <- tract.cent %>% 
  mutate(BoroName = str_replace(BoroName, c("queens|brooklyn"), "brkln_queens"))
test3 <- test2 %>% 
  mutate(borough = str_replace(borough, c("queens|brooklyn"), "brkln_queens"))

st_dist_calc <- function(centroid, stations, name) {
 
  centroid.df <- centroid %>% 
    select(BoroCT2010, BoroName)
  centroid.df$geometry <- NULL
  centroid.tbl <- centroid.df %>% 
    as_tibble()
  result <- centroid.tbl %>% 
    filter(BoroName == name) %>% 
    bind_cols(
      centroid %>% 
        filter(BoroName == name) %>% 
        st_distance(
          stations %>% 
          filter(borough == name)
          ) %>% 
        unclass() %>% 
        as_tibble()
    ) %>% 
    gather("station", "ft_dist", -c(BoroCT2010, BoroName)) %>% 
    group_by(BoroCT2010, BoroName) %>% 
    top_n(-5, ft_dist) %>% 
    mutate(mile_dist = ft_dist / 5280) %>% 
    summarise(
      mean5_all = mean(mile_dist),
      med5_all = median(mile_dist)
      ) %>% 
    ungroup()
  return(result)
}



man_dist_test2 <- st_dist_calc(tract.cent_test, test3, "manhattan")
bronx_dist_test2 <- st_dist_calc(tract.cent_test, test3, "bronx")
brkl_queen_dist_test2 <- st_dist_calc(tract.cent_test, test3, "brkln_queens")

all.equal(man_dist_test, man_dist_test2)
all.equal(bronx_dist_test, bronx_dist_test2)
all.equal(brkl_queen_dist_test %>% select(BoroCT2010, mean5_all:med5_all), brkl_queen_dist_test2 %>% select(BoroCT2010, mean5_all:med5_all))

all_dist_test2 <- man_dist_test2 %>% 
  bind_rows(bronx_dist_test2) %>% 
  bind_rows(brkl_queen_dist_test2)

all.equal(all_dist_test %>% select(BoroCT2010, mean5_all:med5_all), all_dist_test2 %>% select(BoroCT2010, mean5_all:med5_all))


st_dist_calc2 <- function(name, centroid, stations) {
 
  centroid.df <- centroid %>% 
    select(BoroCT2010, BoroName)
  centroid.df$geometry <- NULL
  centroid.tbl <- centroid.df %>% 
    as_tibble()
  result <- centroid.tbl %>% 
    filter(BoroName == name) %>% 
    bind_cols(
      centroid %>% 
        filter(BoroName == name) %>% 
        st_distance(
          stations %>% 
          filter(borough == name)
          ) %>% 
        unclass() %>% 
        as_tibble()
    ) %>% 
    gather("station", "ft_dist", -c(BoroCT2010, BoroName)) %>% 
    group_by(BoroCT2010, BoroName) %>% 
    top_n(-5, ft_dist) %>% 
    mutate(mile_dist = ft_dist / 5280) %>% 
    summarise(
      mean5 = mean(mile_dist),
      med5 = median(mile_dist),
      min1 = min(mile_dist)
      ) %>% 
    ungroup()
  return(result)
}


all_stations_list <-  map_dfr(c("manhattan", "bronx", "brkln_queens"), ~ st_dist_calc2(., tract.cent_test, test3))
ada_stations_list <- map_dfr(c("manhattan", "bronx", "brkln_queens"), ~ st_dist_calc2(., tract.cent_test, test3 %>% filter(ada)))





ada_stations_list %>% 
  gather("measure", "distance", mean5:med5) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 50) +
  facet_wrap(~ measure)
ada_stations_list %>% 
  ggplot(aes(mean5, med5)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, alpha = 0.5, color = "slategrey", size = 2)
all_stations_list %>% 
  gather("measure", "distance", mean5:med5) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 50) +
  facet_wrap(~ measure)
all_stations_list %>% 
  ggplot(aes(mean5, med5)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, alpha = 0.5, color = "slategrey", size = 2)


nyc.map.4boro %>% 
  inner_join(all_stations_list, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean5)) +
  scale_fill_viridis_c(option = "D")
nyc.map.4boro %>% 
  inner_join(ada_stations_list, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean5)) +
  scale_fill_viridis_c(option = "D")
nyc.map.4boro %>% 
  inner_join(ada_stations_list, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med5)) +
  scale_fill_viridis_c(option = "D")

all_stations_list %>% 
  ggplot(aes(min1)) +
  geom_histogram(bins = 50)
ada_stations_list %>% 
  ggplot(aes(min1)) +
  geom_histogram(bins = 50)
nyc.map.4boro %>% 
  inner_join(all_stations_list, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = min1)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(ada_stations_list, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = min1)) +
  scale_fill_viridis_c(option = "B")
```


```{r}
diff_stations <- all_stations_list %>% 
  inner_join(ada_stations_list %>% select(-BoroName), by = "BoroCT2010", suffix = c("_all", "_ada")) %>% 
  mutate(
    mean_diff = mean5_ada - mean5_all,
    med_diff = med5_ada - med5_all,
    min_diff = min1_ada - min1_all
  )
diff_stations %>% 
  select(-c(mean5_all:min1_ada)) %>% 
  gather("measure", "distance", mean_diff:min_diff) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 50) +
  facet_wrap(~ measure)
nyc.map.4boro %>% 
  inner_join(diff_stations, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med_diff)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(diff_stations, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean_diff)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(diff_stations, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = min_diff)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(diff_stations, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = min_diff)) +
  scale_fill_viridis_c(option = "B")
```











The ratio normalization doesn't really work so well, the subtraction is probably the better choice in this case.

Next steps:
- Separate distance calculations by borough for both the random point and the station, in case "closest" stations are across a river. Probably can keep Queens and Brooklyn together?
- Incorporate outage data to find the "true" dead zones? Or areas that are usually suffering from long-term outages of accessibility equipment?
- Find a better NYC map overlay - is it the 311 long,lat data that's the problem, or the map I got from ggmap? 


```{r, eval = FALSE}
test.map <- readOGR("./data/nyct2010_18a", "nyct2010")
tm_shape(test.map) +
  tm_borders() 
test.map2 <- fortify(test.map)
ggplot(test.map2, aes(x = long, y = lat, group = group)) +
  geom_polygon(fill = NA, color = "black")
test.map3 <- test.map[test.map$BoroName != "Staten Island", ]
tm_shape(test.map3) +
  tm_borders() 
dist.points <- SpatialPoints(dist.merge[, c(4, 3)])
proj4string(dist.points) <- CRS("+init=epsg:4326")
#proj4string(dist.points) <- CRS("+proj=lcc +lat_1=41.03333333333333 +lat_2=40.66666666666666 +lat_0=40.16666666666666 +lon_0=-74 +x_0=300000.0000000001 +y_0=0 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs")
plot(dist.points)
dist.points <- spTransform(dist.points, proj4string(test.map3))
dist.by.tract <- over(dist.points, test.map3)
dist.by.tract.frt <- fortify(dist.by.tract)
test4 <- dist.merge %>% 
  bind_cols(dist.by.tract.frt)
test5 <- test4 %>% 
  group_by(CT2010) %>% 
  summarize(avg_to_ada_stat = mean(top5.any.vs.ada.mean.dist))
test6 <- test4 %>% 
  group_by(NTAName) %>% 
  summarize(avg_to_ada_stat = mean(top5.any.vs.ada.mean.dist)) %>% 
  arrange(desc(avg_to_ada_stat))
merge.to.map <- merge(test.map3, test5, by.x = "CT2010", by.y = "CT2010")
merge.to.map2 <- merge.to.map
merge.to.map2[str_detect(merge.to.map2$NTAName, "park-cemetery-etc") | str_detect(merge.to.map2$NTAName, "Airport"), ] <- NA
tm_shape(merge.to.map2) +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "A"))
tm_shape(merge.to.map2) +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "B"))
tm_shape(merge.to.map2) +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "C"))
tm_shape(merge.to.map2) +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "D"))
tm_shape(merge.to.map2) +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "E"))
tm_shape(merge.to.map2) +
  tm_borders() +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "A"))
merge.to.map.neigh <- merge(test.map3, test6, by.x = "NTAName", by.y = "NTAName")
merge.to.map.neigh[str_detect(merge.to.map.neigh$NTAName, "park-cemetery-etc") | str_detect(merge.to.map.neigh$NTAName, "Airport"), ] <- NA
tm_shape(merge.to.map.neigh) +
  tm_borders()+
  tm_fill("avg_to_ada_stat", midpoint = NA, palette = viridis(n = 6, option = "A"))

sum(str_detect(merge.to.map$NTAName, "park-cemetery-etc"))
merge.parks <- merge.to.map[str_detect(merge.to.map$NTAName, "park-cemetery-etc"),]
tm_shape(merge.parks) +
  tm_fill()
```