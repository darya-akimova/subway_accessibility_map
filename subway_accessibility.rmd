---
title: "underserviced_areas"
author: "Darya Akimova"
date: "August 23, 2018"
output: 
  html_document:
    toc: true
    toc_float:
      smooth_scroll: false
    number_sections: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

Main question to address: What areas of NYC are under-serviced by ADA accessible stations?

Plan: Somehow randomly "sample" locations in the NYC territory in (longitude, latitude) unit pairs and then calculate distance from that point to the nearest ada-certified (accessible) subway station. Normalize to nearest (accessible or not accessible) station? 

Need:
- Data for which stations are ADA-accessible
- Data for station locations (longitude, latitude)
- Some way to sample the territory of NYC (it's an odd shape)

# Setup

## Packages

```{r packages, comment=NA}
library(tidyverse)
library(ggmap)
library(sf)
library(ggthemes)
```


## Data

```{r data, comment=NA}
nyc.census.map <- st_read("./data/nyct2010_18a/nyct2010.shp")
subway.ent.exit <- read_csv("./data/2018_update/NYC_Transit_Subway_Entrance_And_Exit_Data.csv")
subway.by.line <- read_csv("./data/2018_update/nyc_subway_stations_grouped.csv")
num.stat.by.route <- read_csv("./data/2018_update/nyc_subway_num_stat_by_line.csv")
```


```{r preview, comment=NA}
plot(nyc.census.map$geometry)
# subway entrances/exit data:
glimpse(subway.ent.exit)
# subway summary data
glimpse(subway.by.line)
glimpse(num.stat.by.route)
```

First things first, cleanup the column names of the two subway info dataframes by converting the words to lower-case and by replacing empty spaces with `_`:

```{r comment=NA}
colnames(subway.ent.exit) <- colnames(subway.ent.exit) %>% 
  str_to_lower() %>% 
  str_replace_all(" ", "_")
colnames(subway.ent.exit)
colnames(subway.by.line) <- colnames(subway.by.line) %>% 
  str_to_lower() %>% 
  str_replace_all(" ", "_")
colnames(subway.by.line)
```

Much better! 

Now for some cleanup of the subway entrance/exit dataset:

* Create a unique station name column by combining the division. line, and station_name
* Gather the route names into one column and get rid of all of the missing values


```{r}
sub.line.tidy <- subway.by.line %>% 
  separate(lines, into = c(paste("route", 1:4, sep = "_")), remove = FALSE) %>% 
  gather("route_num", "route_name", route_1:route_4) %>% 
  filter(!is.na(route_name)) %>% 
  select(-route_num) %>% 
  arrange(route_name)
glimpse(sub.line.tidy)


subway.ent.exit %>% 
  select(route1:route11) %>% 
  gather("route_num", "route_name") %>% 
  filter(!(is.na(route_name))) %>% 
  select(-route_num) %>% 
  distinct() %>% 
  anti_join(sub.line.tidy, by = "route_name")



length(unique(subway.ent.exit$station_name))
# NYC considers 472 to be the number of subway stations in the city, 424 if connected stations are considered single stations
nrow(subway.ent.exit %>% select(station_name, station_latitude:station_longitude) %>% distinct())

nrow(subway.ent.exit %>% select(division:station_name) %>% distinct())
sub.ext.cln <- subway.ent.exit %>% 
  mutate_at(vars(division:station_name), str_to_lower) %>% 
  unite("stat_name", division:station_name, sep = "_") %>% 
  mutate_at(vars(route1:route11), str_to_upper) %>% 
  distinct()
length(unique(sub.ext.cln$stat_name))
  



```



```{r}
sub.sml.test <- sub.ext.cln %>% 
  select(stat_name:station_longitude, entrance_latitude:entrance_longitude, route1:route11, entrance_type:entry, ada, free_crossover) %>%
  replace_na(
    list(
      route1 = "", route2 = "", route3 = "", route4 = "", 
      route5 = "", route6 = "", route7 = "", route8 = "", 
      route9 = "", route10 = "", route11 = ""
      )
    ) %>% 
  unite("routes", route1:route11, sep = "") %>% 
  distinct()
table(sub.sml.test$free_crossover)

sub.sml.test %>% 
  select(stat_name, free_crossover) %>% 
  distinct() %>% 
  group_by(stat_name) %>% 
  count() %>% 
  filter(n > 1)
sub.sml.test %>% 
  select(stat_name, free_crossover) %>% 
  distinct() %>% 
  filter(!free_crossover)
sub.sml.test %>% 
  select(stat_name, free_crossover, ada) %>% 
  distinct() %>% 
  group_by(ada, free_crossover) %>% 
  count()
subway.ent.exit %>% 
  filter(ada & !free_crossover)

percent_ada <- sub.sml.test %>% 
  group_by(stat_name) %>% 
  summarize(
    num_entry = n(),
    num_ada = sum(ada),
    percent_ada = round(num_ada * 100 / num_entry, 2)
  )
hist(percent_ada$percent_ada)
table(percent_ada$percent_ada)
table(sub.sml.test$entrance_type)

sub.sml.test %>% 
  group_by(station_latitude, station_longitude) %>% 
  summarize(
    num_entry = n(),
    num_ada = sum(ada),
    percent_ada = round(num_ada * 100 / num_entry, 2)
  ) %>% 
  {table(.$percent_ada)}
sub.sml.test %>% 
  group_by(station_latitude, station_longitude) %>% 
  summarize(
    num_entry = n(),
    num_free_cross = sum(free_crossover),
    percent_free_cross = round(num_free_cross * 100 / num_entry, 2)
  ) %>% 
  {table(.$percent_free_cross)}
sub.sml.test %>% 
  group_by(entrance_type, ada) %>% 
  count() %>% 
  ggplot(aes(entrance_type, n, fill = ada)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  scale_fill_tableau()
sub.sml.test %>% 
  group_by(entrance_type, ada) %>% 
  count() %>% 
  ggplot(aes(entrance_type, n, fill = ada)) +
  geom_bar(stat = "identity", position = "fill") +
  theme_minimal() +
  scale_fill_tableau()
sub.sml.test %>% 
  group_by(entrance_type, free_crossover) %>% 
  count() %>% 
  ggplot(aes(entrance_type, n, fill = free_crossover)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  scale_fill_tableau()



```


```{r comment=NA}
# note that the sta
length(unique(subway.ent.exit$station_name))
nrow(subway.ent.exit %>% select(station_name, station_latitude:station_longitude) %>% distinct())
nrow(subway.ent.exit %>% select(division:station_name) %>% distinct())
sub.ext.cln %>% 
  select(stat_name, ada, ada_notes) %>% 
  filter(!(is.na(ada_notes))) %>% 
  distinct()

sub.stat.coord <- sub.ext.cln %>% 
  select(stat_name:station_longitude) %>% 
  distinct() %>% 
  group_by(stat_name) %>% 
  summarize(
    avg_stat_lat = mean(station_latitude),
    avg_stat_long = mean(station_longitude)
  )

sub.ext.sml <- sub.ext.cln %>% 
  select(stat_name, route1:route11, ada, ada_notes) %>% 
  inner_join(sub.stat.coord, by = "stat_name") %>% 
  distinct() %>% 
  gather("route_num", "route_name", route1:route11) %>% 
  filter(!is.na(route_name)) %>% 
  select(-route_num) %>% 
  distinct()
glimpse(sub.ext.sml)
sapply(sub.ext.sml, anyNA)
length(unique(sub.ext.sml$stat_name))
sub.ext.sml %>% 
  select(stat_name, route_name) %>% 
  distinct() %>% 
  nrow()

sub.ext.sml %>% 
  select(stat_name, ada, ada_notes) %>% 
  distinct() %>% 
  filter(!(is.na(ada_notes)))
sub.ext.sml %>% 
  filter(stat_name == "ind_8 avenue_world trade center")

sub.ext.sml %>%
  filter(str_detect(stat_name, "ind")) %>% 
  separate(stat_name, into = c("division", "line", "station_name"), sep = "_") %>% 
  {table(.$line)}
sub.ext.sml %>%
  filter(str_detect(stat_name, "irt")) %>% 
  separate(stat_name, into = c("division", "line", "station_name"), sep = "_") %>% 
  {table(.$line)}
sub.ext.sml %>% 
  filter(route_name == "G") %>% 
  ggplot(aes(avg_stat_long, avg_stat_lat)) + 
  geom_point() + 
  coord_quickmap()
# G train missing station stops between Smith 9th St and Church Ave, where the service 
# should add those in - follows the F train here, get the slice of stations: 
sub.ext.sml %>% 
  filter(route_name == "F") %>% 
  arrange(avg_stat_lat) %>% 
  filter(avg_stat_lat > 40.62976 & avg_stat_lat < 40.68030)
sub.ext.sml %>% 
  filter(route_name == "F") %>% 
  arrange(avg_stat_lat) %>% 
  filter(avg_stat_lat > 40.62976 & avg_stat_lat < 40.68030 & str_detect(stat_name, "4")) %>% 
  ggplot(aes(avg_stat_long, avg_stat_lat)) +
  geom_point()
sub.ext.sml %>% 
  filter(route_name == "F") %>% 
  arrange(avg_stat_lat) %>% 
  filter(avg_stat_lat > 40.62976 & avg_stat_lat < 40.68030) %>% 
  ggplot(aes(avg_stat_long, avg_stat_lat)) +
  geom_point() +
  coord_quickmap()

# G train is considered IND - grab that 4th ave station
sub.ext.sml.rt.fix <- sub.ext.sml %>% 
  bind_rows(
    sub.ext.sml %>% 
      filter(route_name == "F") %>% 
      arrange(avg_stat_lat) %>% 
      filter(avg_stat_lat > 40.63612 & avg_stat_lat < 40.67358 & str_detect(stat_name, "ind")) %>% 
      mutate(route_name = "G")
)

nyc.map.4boro <- nyc.census.map %>%  
  filter(BoroName != "Staten Island") %>% 
  mutate(BoroName = str_to_lower(BoroName))
nyc.map.4boro %>% filter(str_detect(NTAName, "park") | str_detect(NTAName, "Airport")) %>% ggplot() +geom_sf()
nyc.map.4boro %>% 
  filter(!(str_detect(NTAName, "park") | str_detect(NTAName, "Airport"))) %>% 
  ggplot(aes(Shape_Area)) +
  geom_histogram()
nyc.map.4boro.crs.geo <- st_transform(nyc.map.4boro, crs = "+init=epsg:4326")

sub.ext.sml.rt.fix %>% 
  filter(route_name == "F" | route_name == "G") %>% 
  ggplot(aes(avg_stat_long, avg_stat_lat, color = route_name)) +
  geom_point(size = 2, alpha = 0.8) +
  coord_quickmap()
nyc.map.4boro.crs.geo %>% 
  ggplot() +
  geom_sf() +
  geom_point(
    data = sub.ext.sml.rt.fix %>% 
      filter(route_name == "F" | route_name == "G"),
    aes(avg_stat_long, avg_stat_lat, color = route_name),
    size = 2, alpha = 0.8
    ) +
  theme_minimal()
nyc.map.4boro.crs.geo %>% 
  ggplot() +
  geom_sf() +
  geom_point(
    data = sub.ext.sml.rt.fix %>% 
      filter(route_name == "F"),
    aes(avg_stat_long, avg_stat_lat, color = route_name),
    size = 2, alpha = 0.8
    ) +
  theme_minimal()




sub.ext.sml.rt.fix %>% 
  select(stat_name, ada, ada_notes) %>% 
  distinct() %>% 
  filter(!(is.na(ada_notes)))


# GS and S routes are redundant - refer to the same thing, the grand central shuttle between times square and grand central
sub.ext.ada.updt %>% 
  filter(route_name == "GS")
sub.ext.ada.updt %>% 
  filter(route_name == "S")
# solution - filter out "S" route, change GS to ada = FALSE
```

To check:

* ind_8 avenue_50th st / TRUE / Southbound Only - Leave as ada = TRUE (no changes)
* ind_8 avenue_world trade center / TRUE / Construction - ada = TRUE for E only 
* ind_archer av_sutphin blvd-archer av - jfk / TRUE / Check - ada = TRUE according to wikipedia page (no change)
* bmt_broadway_49th st / TRUE / Northbound Only - Leave as ada = TRUE (no change)
* bmt_broadway_times square-42nd st / TRUE / Shuttle not ADA - set S to ada = FALSE
* bmt_broadway_union square / TRUE / Lex not ADA - set 4/5/6 to ada = FALSE   
* bmt_canarsie_union square / TRUE / Lex not ADA - same as above      
* ind_concourse_kingsbridge rd / FALSE / in planning - switch to TRUE because it is complete      
* irt_lexington_23rd st / FALSE In Planning - switch to TRUE because it is complete
* irt_lexington_brooklyn bridge-city hall / TRUE / J Z not ADA - set J/Z to ada = FALSE
* irt_lexington_canal st / TRUE / Bway Nass not ADA - Only set 6 ada  = TRUE
* irt_pelham_hunts point av / FALSE / in planning - complete, set ada = TRUE     


* ind_queens boulevard_forest hills-71st av / FALSE / in planning - complete, set ada = TRUE

Note: This dataset has not been updated for the BMT Broadway Line / Yellow Line / NQRW train changes, namely it still includes the old Q route that went into Queens, and does not include the 3 new stations that were opened along 2nd Ave in Manhattan, all of which are ADA-Accessible.

```{r comment = NA}
sub.ext.ada.updt <- sub.ext.sml.rt.fix %>% 
  # change world trade center station ada
  mutate(ada = ifelse((stat_name == "ind_8 avenue_world trade center" & route_name != "E"), FALSE, ada)) %>% 
  # change times square shuttle ada, filter out extra "S" route
  filter(route_name != "S") %>% 
  mutate(ada = ifelse(route_name == "GS", FALSE, ada)) %>% 
  # change 4/5/6 at union square to ada = FALSE
  mutate(ada = ifelse(
      (
        (stat_name == "bmt_broadway_union square" | stat_name == "bmt_canarsie_union square") &
        (route_name == "4" | route_name == "5" | route_name == "6")
      ), FALSE, ada)) %>% 
  # change kingsbridge rd ada = TRUE
  mutate(ada = ifelse(stat_name == "ind_concourse_kingsbridge rd", TRUE, ada)) %>% 
  # change Lex / 23rd St stop to TRUE
  mutate(ada = ifelse(stat_name == "irt_lexington_23rd st", TRUE, ada)) %>% 
  # change J/Z at Brooklyn Bridge / City Hall to ada = FALSE
  mutate(ada = ifelse(
    (stat_name == "irt_lexington_brooklyn bridge-city hall" & (route_name == "J" | route_name == "Z")),
    FALSE, ada)) %>% 
  # change irt_lexington_canal st to ada = TRUE for 6 train only
  mutate(ada = ifelse(
    (stat_name == "irt_lexington_canal st" & route_name != "6"), FALSE, ada
  )) %>% 
  # change rt 6 hunts point av to ada = TRUE
  mutate(ada = ifelse(stat_name == "irt_pelham_hunts point av", TRUE, ada)) %>% 
  # convert the forst hills / 71st ave station to ada = TRUE for all lines
  mutate(ada = ifelse(stat_name == "ind_queens boulevard_forest hills-71st av", TRUE, ada)) %>% 
  select(-ada_notes) %>% 
  distinct()
dim(sub.ext.sml.rt.fix)
dim(sub.ext.ada.updt)
table(sub.ext.ada.updt$ada)


percent.ada.updt <- sub.ext.ada.updt %>% 
  group_by(stat_name) %>% 
  summarize(
    num_entry = n(),
    num_ada = sum(ada),
    percent_ada = round(num_ada * 100 / num_entry, 2)
  )
hist(percent.ada.updt$percent_ada)
table(percent.ada.updt$percent_ada)
percent.ada.updt %>% 
  group_by(num_entry) %>% 
  count() %>% 
  ggplot(aes(num_entry, n)) +
  geom_bar(stat = "identity")
percent.ada.updt %>%
  group_by(num_ada) %>% 
  count() %>% 
  ggplot(aes(num_ada, n)) +
  geom_bar(stat = "identity")
```


This process brought up an additional problem - lines are assigned to routes that they do not belong in, and there are extra stops (probably because some stations are connected and technically the entrances/exits apply to those routes as well).

```{r comment=na}
stat.by.route.count <- sub.ext.ada.updt %>% 
  group_by(route_name) %>% 
  count()  
stat.by.route.count %>%  
  ggplot(aes(route_name, n)) +
  geom_bar(stat = "identity")
stat.route.join <- stat.by.route.count %>% 
  full_join(num.stat.by.route, by = "route_name") %>% 
  filter(route_name != "W")
stat.route.join %>% 
  ggplot(aes(num_stations_norm, n)) +
  geom_abline(intercept = 0, slope = 1, size = 1, alpha = 0.8) +
  geom_point(size = 2, alpha = 0.8) +
  xlab("stat num by route (wiki)") +
  ylab("stat num by route (count)")
stat.route.join %>% 
  filter(num_stations_norm == n)
```


```{r comment=NA}
num.stat.by.route %>% 
  filter(route_name == "GS")
sub.ext.ada.updt %>% 
  filter(route_name == "GS") %>% 
  arrange(stat_name)
sub.stat.num.updt <- sub.ext.ada.updt %>% 
  filter(!(route_name == "GS" & (str_detect(stat_name, "flushing") | str_detect(stat_name, "lexington"))))
num.stat.by.route %>% 
  filter(route_name == "FS")
stat.by.route.count %>% 
  filter(route_name == "FS")
sub.stat.num.updt %>% 
  filter(route_name == "FS") %>% 
  arrange(avg_stat_lat)
# remove the ind and irt stations - those are the extras
sub.stat.num.updt <- sub.stat.num.updt %>% 
  filter(!(route_name == "FS" & (str_detect(stat_name, "irt") | str_detect(stat_name, "ind"))))
sub.stat.num.updt %>% 
  filter(route_name == "FS")
sub.stat.num.updt %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>% 
  filter(num_stations_norm == min(num_stations_norm))
# G route fix
sub.line.tidy %>% 
  filter(route_name == "G")

sub.stat.num.updt %>% 
  filter(route_name == "G") %>% 
  select(avg_stat_lat, avg_stat_long) %>% 
  distinct() %>% 
  nrow()

sub.stat.num.updt.G <- sub.stat.num.updt %>% 
  filter(route_name != "G") %>% 
  bind_rows(
    sub.stat.num.updt %>% 
      filter(route_name == "G" & str_detect(stat_name, "ind") & stat_name != "ind_queens boulevard_23rd st-ely av")
    )
sub.stat.num.updt.G %>% 
  filter(route_name == "G") %>% 
  nrow()
# Z route fix
sub.line.tidy %>% 
  filter(route_name == "Z")
sub.stat.num.updt.Z <- sub.stat.num.updt.G %>% 
  filter(route_name != "Z") %>% 
  bind_rows(
    sub.stat.num.updt.G %>% 
      filter(route_name == "Z" & str_detect(stat_name, "bmt") & stat_name != "bmt_broadway_canal st (ul)") %>% 
      # Z train was not included on the list of trains at broadway junction stop in Queens (was A/C/J/L)
      bind_rows(
        sub.stat.num.updt.G %>% 
          filter(str_detect(stat_name, "broadway junction")) %>% 
          mutate(route_name = "Z") %>% 
          distinct()
        ) %>% 
      # Z train was also not listed on Alabama Ave stop in Queens (was J only)
      bind_rows(
        sub.stat.num.updt.G %>% 
          filter(str_detect(stat_name, "alabama")) %>% 
          mutate(route_name = "Z")
      ) %>% 
      # add back in the jamaica center and jfk airport stops that were filtered out
      bind_rows(
        sub.stat.num.updt.G %>% 
          filter(route_name == "Z" & avg_stat_long > -73.82829)
        )
    )
sub.stat.num.updt.Z %>% 
  filter(route_name == "Z") %>% 
  nrow()

## Next fix targets ##
sub.stat.num.updt.Z %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>% 
  filter(num_stations_norm == min(num_stations_norm))

# 7 Train, goal: 22
sub.line.tidy %>% 
  filter(route_name == "7")
sub.stat.num.updt.7 <-  sub.stat.num.updt.Z %>%
  filter(route_name != "7") %>% 
  bind_rows(
    sub.stat.num.updt.Z %>% 
      filter(route_name == "7" & str_detect(stat_name, "irt")) %>% 
      # eliminate station copies
      filter(
        # times square extra
        stat_name != "irt_42nd st shuttle_times square" &
        # grand central extra
          stat_name != "irt_42nd st shuttle_grand central" &
          stat_name != "irt_lexington_grand central-42nd st"
          ) %>% 
      mutate(ada = ifelse(stat_name == "irt_flushing_45 rd-court house sq", TRUE, ada))
  )
sub.stat.num.updt.7 %>% 
  filter(route_name == "7") %>% 
  nrow()
# E train, goal: 22
sub.line.tidy %>% 
  filter(route_name == "E")
sub.stat.num.updt.E <- sub.stat.num.updt.7 %>% 
  filter(route_name != "E") %>% 
  bind_rows(
    sub.stat.num.updt.7 %>% 
      filter(route_name == "E" & str_detect(stat_name, "ind")) %>% 
      filter(stat_name != "ind_8 avenue_chambers st") %>% 
      mutate(ada = ifelse(stat_name == "ind_archer av_jamaica-van wyck", TRUE, ada)) %>% 
      bind_rows(
        # add in Briarwood station (a late night station)
        sub.stat.num.updt.7 %>% 
          filter(str_detect(stat_name, "briarwood")) %>% 
          mutate(route_name = "E")
        )
    )

## Next fix targets ##
sub.stat.num.updt.E %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>% 
  filter(num_stations_norm == min(num_stations_norm))

# L train, goal: 24
sub.line.tidy %>% 
  filter(route_name == "L")
sub.stat.num.updt.L <-  sub.stat.num.updt.E %>% 
  filter(route_name != "L") %>% 
  bind_rows(
    sub.stat.num.updt.E %>% 
      filter(route_name == "L" & str_detect(stat_name, "bmt")) %>% 
      filter(stat_name != "bmt_broadway_union square") %>% 
      mutate(ada = ifelse(stat_name == "bmt_canarsie_wilson av", TRUE, ada)) %>% 
      # add back in broadway junction
      bind_rows(
        sub.stat.num.updt.E %>% 
          filter(str_detect(stat_name, "broadway junction") & route_name == "L")
        )
    )
sub.stat.num.updt.L %>% 
  filter(route_name == "L") %>% 
  nrow()
## Next fix targets ##
sub.stat.num.updt.L %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>% 
  filter(num_stations_norm == min(num_stations_norm))

# B line: target - 37 - will include rush hour stations 
sub.line.tidy %>% 
  filter(route_name == "B")
sub.stat.num.updt.B <- sub.stat.num.updt.L %>% 
  filter(route_name != "B") %>% 
  bind_rows(
    sub.stat.num.updt.L %>% 
      filter(route_name == "B" & (str_detect(stat_name, "bmt") | str_detect(stat_name, "ind"))) %>% 
      # convert non-ada stations to those that are ada = TRUE now
      mutate(
        ada = ifelse((
          stat_name == "bmt_brighton_kings highway" | 
            stat_name == "ind_6 avenue_broadway-lafayette st" | 
            stat_name == "ind_8 avenue_125th st"
          ), TRUE, ada)
        ) %>% 
      # stations to exclude atlantic ave /barclays duplicates 
      # and stops between barclays and brighton where B does not stop
      filter(!(avg_stat_lat > 40.60867 & avg_stat_lat < 40.63508)) %>% 
      filter(!(
        stat_name %in% c(
          "bmt_broadway_34th st", "bmt_brighton_parkside av", 
          "bmt_4 avenue_pacific st", "bmt_brighton_atlantic av", 
          "bmt_brighton_av u", "bmt_brighton_neck rd", 
          "bmt_brighton_beverly rd", "bmt_brighton_cortelyou rd"
          )
        ))
    )
dim(sub.stat.num.updt.B)

## Next fix targets ##
sub.stat.num.updt.B %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B") %>% 
  filter(num_stations_norm == min(num_stations_norm))

# 4 train, target is 28 - exclude late night service
sub.stat.num.updt.4 <- sub.stat.num.updt.B %>% 
  filter(route_name != "4") %>% 
  bind_rows(
    sub.stat.num.updt.B %>% 
      filter(route_name == "4" & str_detect(stat_name, "irt")) %>% 
      filter(!(
        stat_name %in% c(
          "irt_flushing_grand central-42nd st", "irt_42nd st shuttle_grand central", 
          "irt_clark_fulton st", "irt_clark_borough hall"
          )
        )) %>% 
      mutate(ada = ifelse(stat_name == "irt_lexington_fulton st", TRUE, ada))
    )

# J train, goal: 30
sub.stat.num.updt.J <- sub.stat.num.updt.4 %>% 
  filter(route_name != "J") %>% 
  bind_rows(
    sub.stat.num.updt.4 %>% 
      filter(route_name == "J" & str_detect(stat_name, "bmt")) %>%
      filter(stat_name != "bmt_broadway_canal st (ul)") %>% 
      bind_rows(
        sub.stat.num.updt.4 %>% 
        filter(route_name == "J" & avg_stat_long > -73.82829)
      ) %>% 
      bind_rows(
        sub.stat.num.updt.4 %>% 
              filter(str_detect(stat_name, "broadway junction") & route_name == "J")
      ) %>% 
      mutate(ada = ifelse(stat_name == "bmt_nassau_fulton st", TRUE, ada))
    )

sub.stat.num.updt.J %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")

# route A, goal: 44 stations
sub.stat.num.updt.A <- sub.stat.num.updt.J %>% 
  filter(route_name != "A") %>% 
  bind_rows(
    sub.stat.num.updt.J %>% 
      filter(route_name == "A" & str_detect(stat_name, "ind")) %>%
      filter(!(
        stat_name %in% c(
          "ind_8 avenue_world trade center", "ind_8 avenue_broadway-nassau", 
          "ind_fulton_franklin av", "ind_fulton_kingston-throop",
          "ind_fulton_ralph av", "ind_fulton_rockaway av",
          "ind_fulton_liberty av", "ind_fulton_van siclen av", 
          "ind_fulton_shepherd av"
          )
        )) %>% 
      bind_rows(
        sub.stat.num.updt.J %>% 
          filter(str_detect(stat_name, "fulton st") & route_name == "4") %>% 
          mutate(route_name = "A")
      ) %>% 
      mutate(ada = ifelse(stat_name %in% c("ind_8 avenue_125th st", "ind_rockaway_far rockaway-mott av", "ind_rockaway_aqueduct racetrack", "ind_fulton_jay st - borough hall", "ind_fulton_utica av", "ind_liberty_lefferts blvd"), TRUE, ada)) %>% 
      bind_rows(
        sub.stat.num.updt.J %>% 
          filter(route_name == "H" & !(str_detect(stat_name, "broad channel"))) %>% 
          mutate(route_name = "A")
      )
    )
nrow(sub.stat.num.updt.A)

sub.stat.num.updt.A %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# C next, goal: 40 stations
sub.stat.num.updt.C <- sub.stat.num.updt.A %>% 
  filter(route_name != "C") %>% 
  bind_rows(
    sub.stat.num.updt.A %>% 
      filter(route_name == "C" & str_detect(stat_name, "ind")) %>% 
      filter(!(stat_name %in% c("ind_8 avenue_broadway-nassau", "ind_8 avenue_world trade center"))) %>% 
      bind_rows(
            sub.stat.num.updt.A %>% 
              filter(str_detect(stat_name, "fulton st") & route_name == "A") %>% 
              mutate(route_name = "C")
        ) %>%
      mutate(ada = ifelse(stat_name %in% c("ind_8 avenue_125th st", "ind_fulton_jay st - borough hall", "ind_fulton_utica av"), TRUE, ada))
)
sub.stat.num.updt.C %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# route 5, goal: 45 
sub.stat.num.updt.5 <- sub.stat.num.updt.C %>% 
  filter(route_name != "5") %>% 
  bind_rows(
    sub.stat.num.updt.C %>% 
      filter(route_name == "5" & str_detect(stat_name, "irt")) %>% 
      filter(!(
        stat_name %in% c(
          "irt_clark_borough hall", "irt_clark_fulton st", 
          "irt_flushing_grand central-42nd st", "irt_42nd st shuttle_grand central", 
          "irt_white plains road_wakefield-241st st"
          )
        )) %>%
      mutate(ada = ifelse(
        stat_name %in% c("irt_lexington_fulton st", "irt_white plains road_east 180th st", "irt_white plains road_gun hill rd"), TRUE, ada
        ))
    )
sub.stat.num.updt.5 %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")

# Next: route 6, goal = 38
sub.stat.num.updt.6 <- sub.stat.num.updt.5 %>% 
  filter(route_name != "6") %>% 
  bind_rows(
    sub.stat.num.updt.5 %>% 
      filter(route_name == "6" & str_detect(stat_name, "irt")) %>% 
      filter(!(stat_name %in% c("irt_flushing_grand central-42nd st", "irt_42nd st shuttle_grand central"))) %>% 
      mutate(ada = ifelse(stat_name %in% c("irt_lexington_bleecker st"), TRUE, ada))
    )
sub.stat.num.updt.6 %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# Next: route D, goal: 36
sub.stat.num.updt.D <- sub.stat.num.updt.6 %>% 
  filter(route_name != "D") %>% 
  bind_rows(
    sub.stat.num.updt.6 %>% 
      filter(route_name == "D" & (str_detect(stat_name, "ind") | str_detect(stat_name, "bmt"))) %>% 
      filter(!(
        stat_name %in% c(
          "bmt_broadway_34th st", "bmt_4 avenue_pacific st", 
          "bmt_brighton_atlantic av", "bmt_sea beach_new utrecht av", 
          "bmt_brighton_stillwell av")
        )) %>% 
      bind_rows(
        sub.stat.num.updt.6 %>% 
          filter(str_detect(stat_name, "4 avenue_36")) %>% 
          mutate(route_name = "D") %>% 
          distinct()
        ) %>% 
      mutate(ada = ifelse(
        stat_name %in% c("ind_8 avenue_125th st", "ind_6 avenue_broadway-lafayette st", "bmt_west end_bay parkway"), TRUE, ada)
        )
    )

sub.stat.num.updt.D %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")

# Next: route F, goal: 45
sub.stat.num.updt.F <- sub.stat.num.updt.D %>% 
  filter(route_name != "F") %>% 
  bind_rows(
    sub.stat.num.updt.D %>% 
      filter(route_name == "F" & (str_detect(stat_name, "ind") | str_detect(stat_name, "bmt"))) %>% 
      filter(!(
        stat_name %in% c(
          "bmt_broadway_34th st", "bmt_canarsie_6th av", 
          "bmt_nassau_essex st", "bmt_broadway_lawrence st", 
          "bmt_4 avenue_9th st", "bmt_brighton_stillwell av", 
          "bmt_brighton_west 8th st"
          )
        )) %>% 
      mutate(ada = ifelse(stat_name %in% c("ind_6 avenue_broadway-lafayette st", "ind_fulton_jay st - borough hall"), TRUE, ada))
    )
nrow(sub.stat.num.updt.F %>% filter(route_name == "F"))
sub.stat.num.updt.F %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
# Next: route M, goal: 36
sub.stat.num.updt.M <- sub.stat.num.updt.F %>% 
  filter(route_name != "M") %>% 
  bind_rows(
    sub.stat.num.updt.F %>% 
      filter(route_name == "M" & (str_detect(stat_name, "ind") | str_detect(stat_name, "bmt"))) %>% 
      filter(!(stat_name %in% c("bmt_broadway_34th st", "bmt_canarsie_6th av", "bmt_nassau_essex st"))) %>% 
      mutate(ada = ifelse(stat_name %in% c("ind_6 avenue_broadway-lafayette st"), TRUE, ada))
    )
sub.stat.num.updt.M %>% 
  group_by(route_name) %>% 
  count() %>% 
  ungroup() %>% 
  inner_join(num.stat.by.route, by = "route_name") %>% 
  filter(n != num_stations_norm) %>%
  filter(route_name != "B")
```


```{r subway_boro}
set.seed(2018)
nyc311_loc <- read_csv(file = "./data/unique_nyc_2015_311.csv") %>%
  distinct() %>% 
  sample_frac(0.25, replace = FALSE)
glimpse(nyc311_loc)

sub.boro <- sub.ext.sml %>% 
  mutate(join_key = paste(round(station_latitude, 2), round(station_longitude, 2), sep = "_")) %>% 
  left_join(nyc311_loc %>% 
              mutate(latitude = round(Latitude, 2),
                     longitude = round(Longitude, 2),
                     join_key = paste(latitude, longitude, sep = "_")) %>% 
              distinct(), by = "join_key") %>% 
  # cleanup 
  select(stat_name:route_name, Borough) %>% 
  distinct() %>% 
  rename("borough" = Borough) %>% 
  mutate(borough = str_to_lower(borough))
glimpse(sub.boro)

ggplot(sub.boro, aes(station_longitude, station_latitude, color = borough)) +
  geom_point(size = 1, alpha = 0.5)

ggplot(sub.boro, aes(station_longitude, station_latitude, color = borough)) +
  geom_point(size = 1, alpha = 0.5) +
  facet_wrap(~borough, nrow = 2)

# some straight forward manual elimination: 
sub.boro %>% 
  filter(borough == "manhattan" & station_latitude < 40.7) %>% 
  ggplot(aes(station_longitude, station_latitude, color = borough)) +
  geom_point(size = 1, alpha = 0.5) +
  ylim(40.6, 40.9) +
  xlim(-74.05, -73.9)
sub.boro %>% 
  filter(borough == "bronx" & station_latitude < 40.8) %>% 
  ggplot(aes(station_longitude, station_latitude, color = borough)) +
  geom_point(size = 1, alpha = 0.5) +
  ylim(40.75, 40.91) +
  xlim(-73.93, -73.82)
sub.boro <- sub.boro %>% 
  filter(!((borough == "manhattan" & station_latitude < 40.7) | (borough == "bronx" & station_latitude < 40.8))) 

ggplot(sub.boro, aes(station_longitude, station_latitude, color = borough)) +
  geom_point(size = 1, alpha = 0.5)

sub.mult.boro <- sub.boro %>% 
  select(stat_name:station_longitude, borough) %>% 
  distinct() %>% 
  group_by(stat_name, station_latitude, station_longitude) %>% 
  count() %>% 
  filter(n > 1) %>% 
  arrange(stat_name)
glimpse(sub.mult.boro)

testing <- sub.boro %>% 
  select(stat_name:station_longitude, borough, route_name) %>% 
  distinct() %>% 
  group_by(stat_name, station_latitude, station_longitude, route_name) %>% 
  count() %>% 
  filter(n > 1) %>% 
  arrange(stat_name)
sub.mult.boro %>% anti_join(testing, by = "stat_name")
testing %>% anti_join(sub.mult.boro, by = "stat_name")

sub.test <- sub.boro %>% 
  filter(stat_name %in% sub.mult.boro$stat_name) %>% 
  select(stat_name:station_longitude, borough) %>% 
  distinct()
sub.test2 <- sub.boro %>% 
  filter(stat_name %in% sub.mult.boro$stat_name) %>% 
  select(stat_name:station_longitude, route_name, borough) %>% 
  arrange(stat_name, route_name, borough) %>% 
  distinct()

sub.boro <- sub.boro %>% 
  filter(
    !(
      (stat_name == "ind_6 avenue_east broadway" & borough == "brooklyn") | 
      (stat_name == "ind_63rd street_roosevelt island" & borough == "queens") |
      (stat_name == "bmt_broadway jamaica_crescent st" & borough == "queens") |
      (stat_name == "bmt_broadway jamaica_cypress hills" & borough == "queens") |
      (stat_name == "bmt_broadway jamaica_elderts lane-75th st" & borough == "brooklyn") |
      (stat_name == "irt_broadway-7th ave_207th st" & borough == "bronx") |
      # techincally, this station is considred part of Manhattan, but it's not on Manhattan island itself
      (stat_name == "irt_broadway-7th ave_marble hill-225th st" & borough == "manhattan") |
      (stat_name == "bmt_canarsie_halsey st" & borough == "brooklyn") |
      (stat_name == "bmt_canarsie_jefferson st" & borough == "queens") |
      (stat_name == "bmt_canarsie_myrtle av" & borough == "queens") |
      (stat_name == "bmt_canarsie_wilson av" & borough == "queens") |
      (stat_name == "ind_crosstown_21st st" & borough == "brooklyn") |
      (stat_name == "irt_flushing_hunters point" & borough == "brooklyn") |
      (stat_name == "irt_flushing_vernon blvd-jackson av" & borough == "brooklyn") |
      (stat_name == "ind_fulton_euclid av" & borough == "queens") |
      (stat_name == "irt_jerome_138th st" & borough == "manhattan") |
      (stat_name == "irt_jerome_149th st-grand concourse" & borough == "manhattan") |
      (stat_name == "ind_liberty_80th st-hudson st" & borough == "brooklyn") |
      (stat_name == "ind_liberty_grant av" & borough == "queens") |
      (stat_name == "bmt_myrtle_forest av" & borough == "brooklyn") |
      (stat_name == "bmt_myrtle_seneca av" & borough == "brooklyn") |
      (stat_name == "irt_pelham_138th st-3rd ave" & borough == "manhattan")
      )
    )
sub.boro %>% 
  select(stat_name:station_longitude, borough) %>% 
  distinct() %>% 
  group_by(stat_name, station_latitude, station_longitude) %>% 
  count() %>% 
  filter(n > 1) %>% 
  arrange(stat_name)
route.mult <- sub.boro %>% 
  group_by(station_latitude, station_longitude, route_name) %>% 
  count() %>% 
  filter(n > 1) %>% 
  unite("stat_key", station_latitude:station_longitude, sep = "_", remove = FALSE) %>% 
  inner_join(
    sub.boro %>% 
      unite("stat_key", station_latitude:station_longitude, sep = "_"),
    by = "stat_key"
  ) %>% 
  filter(route_name.x == route_name.y) %>% 
  arrange(station_latitude, station_longitude, route_name.x, stat_name)
unique(route.mult$stat_name)


identical(
  sub.boro %>% filter(stat_name == "bmt_brighton_west 8th st") %>% select(-stat_name),
  sub.boro %>% filter(stat_name == "bmt_coney island_west 8th st") %>% select(-stat_name)
)
identical(
  sub.boro %>% filter(stat_name == "bmt_brighton_stillwell av") %>% select(-stat_name),
  sub.boro %>% filter(stat_name == "bmt_coney island_stillwell av") %>% select(-stat_name) 
)
identical(
  sub.boro %>% filter(stat_name == "bmt_4 avenue_atlantic av-barclays ctr") %>% select(-stat_name),
  sub.boro %>% filter(stat_name == "bmt_4 avenue_pacific st") %>% select(-stat_name)
  )
sub.boro <- sub.boro %>% 
  filter(
    !(
      stat_name == "bmt_coney island_west 8th st" |
      stat_name == "bmt_coney island_stillwell av" |
      stat_name == "bmt_4 avenue_pacific st"
    )
  )
```


```{r}
stat.by.route <- sub.boro %>% 
  group_by(route_name) %>% 
  summarize(
    total_stat = n(),
    num_ada = sum(ada),
    per_ada = num_ada * 100 / total_stat
  ) %>% 
  mutate(
    rt_mod = ifelse(
      route_name == "GS" | route_name == "FS" | route_name == "H",
      "S",
      route_name
      )
    ) %>% 
  left_join(sub.line.tidy, by = c("rt_mod" = "route_name")) %>% 
  arrange(primary_trunk_line, route_name) 
stat.by.route$rt_order <- factor(stat.by.route$route_name, levels = stat.by.route$route_name)

subway.by.line <- subway.by.line %>% 
  arrange(primary_trunk_line)

stat.by.route %>% 
  ggplot(aes(rt_order, total_stat, fill = primary_trunk_line)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = subway.by.line$hexadecimal)
stat.by.route %>% 
  ggplot(aes(rt_order, num_ada, fill = primary_trunk_line)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = subway.by.line$hexadecimal)
stat.by.route %>% 
  ggplot(aes(rt_order, per_ada, fill = primary_trunk_line)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = subway.by.line$hexadecimal)
stat.by.route %>% 
  ggplot(aes(total_stat, num_ada, color = primary_trunk_line)) +
  geom_abline(slope = 1, intercept = 0, alpha = 0.5, size = 1.5) +
  geom_point(size = 3) +
  scale_color_manual(values = subway.by.line$hexadecimal)
stat.by.route %>% 
  ggplot(aes(total_stat, per_ada, color = primary_trunk_line)) +
  geom_point(size = 3) +
  scale_color_manual(values = subway.by.line$hexadecimal)
stat.by.route %>% 
  ggplot(aes(total_stat, per_ada, color = primary_trunk_line, label = route_name)) +
  geom_point(size = 3) +
  scale_color_manual(values = subway.by.line$hexadecimal) +
  geom_text(hjust = 0, vjust = 0, check_overlap = TRUE, nudge_y = 1.5)
```



```{r dist_calc}
nyc.map.4boro <- nyc.census.map %>%  
  filter(BoroName != "Staten Island") %>% 
  mutate(BoroName = str_to_lower(BoroName))
tract.cent <- st_centroid(nyc.map.4boro)
plot(st_geometry(nyc.map.4boro), col = "grey", border = "white")
plot(tract.cent, pch = 16, cex = 0.25, col = "#D55E00", add = TRUE)



sub.small <- sample_n(sub.boro, size = 20)
test <- st_as_sf(sub.boro, coords = c("station_longitude", "station_latitude"), crs = 4326)
test2 <- st_transform(test, crs = st_crs(nyc.map.4boro))

plot(st_geometry(nyc.map.4boro), col = "grey", border = "white")
plot(test2, pch = 16, cex = 1, col = "#D55E00", add = TRUE)


test.10 <- tract.cent %>% 
  select(BoroCT2010, BoroName)
test.10$geometry <- NULL
test.10 <- test.10 %>% 
  as_tibble()

man_dist_test <- test.10 %>% 
  filter(BoroName == "manhattan") %>% 
  bind_cols(
    tract.cent %>% 
      filter(BoroName == "manhattan") %>% 
      st_distance(
        test2 %>% 
        filter(borough == "manhattan")
        ) %>% 
      unclass() %>% 
      as_tibble()
  ) %>% 
  gather("station", "ft_dist", -c(BoroCT2010, BoroName)) %>% 
  group_by(BoroCT2010, BoroName) %>% 
  top_n(-5, ft_dist) %>% 
  mutate(mile_dist = ft_dist / 5280) %>% 
  summarise(
    mean5_all = mean(mile_dist),
    med5_all = median(mile_dist)
    ) %>% 
  ungroup()
man_dist_test %>% 
  gather("measure", "distance", mean5_all:med5_all) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 15) +
  facet_wrap(~ measure)

nyc.map.4boro %>% 
  inner_join(man_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med5_all)) +
  scale_fill_viridis_c(option = "D")




bronx_dist_test <- test.10 %>% 
  filter(BoroName == "bronx") %>% 
  bind_cols(
    tract.cent %>% 
      filter(BoroName == "bronx") %>% 
      st_distance(
        test2 %>% 
        filter(borough == "bronx")
        ) %>% 
      unclass() %>% 
      as_tibble()
  ) %>% 
  gather("station", "ft_dist", -c(BoroCT2010, BoroName)) %>% 
  group_by(BoroCT2010, BoroName) %>% 
  top_n(-5, ft_dist) %>% 
  mutate(mile_dist = ft_dist / 5280) %>% 
  summarise(
    mean5_all = mean(mile_dist),
    med5_all = median(mile_dist)
    ) %>% 
  ungroup()

bronx_dist_test %>% 
  gather("measure", "distance", mean5_all:med5_all) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 15) +
  facet_wrap(~ measure)


nyc.map.4boro %>% 
  inner_join(bronx_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med5_all)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(bronx_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean5_all)) +
  scale_fill_viridis_c(option = "B")




brkl_queen_dist_test <- test.10 %>% 
  filter(BoroName == "brooklyn" | BoroName == "queens") %>% 
  bind_cols(
    tract.cent %>% 
      filter(BoroName == "brooklyn" | BoroName == "queens") %>% 
      st_distance(
        test2 %>% 
        filter(borough == "brooklyn" | borough == "queens")
        ) %>% 
      unclass() %>% 
      as_tibble()
  ) %>% 
  gather("station", "ft_dist", -c(BoroCT2010, BoroName)) %>% 
  group_by(BoroCT2010, BoroName) %>% 
  top_n(-5, ft_dist) %>% 
  mutate(mile_dist = ft_dist / 5280) %>% 
  summarise(
    mean5_all = mean(mile_dist),
    med5_all = median(mile_dist)
    ) %>% 
  ungroup()

brkl_queen_dist_test %>% 
  gather("measure", "distance", mean5_all:med5_all) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 15) +
  facet_wrap(~ measure)


nyc.map.4boro %>% 
  inner_join(brkl_queen_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med5_all)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(brkl_queen_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean5_all)) +
  scale_fill_viridis_c(option = "B")


all_dist_test <- man_dist_test %>% 
  bind_rows(bronx_dist_test) %>% 
  bind_rows(brkl_queen_dist_test)

nyc.map.4boro %>% 
  inner_join(all_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med5_all)) +
  scale_fill_viridis_c(option = "B")
  
nyc.map.4boro %>% 
  inner_join(all_dist_test, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean5_all)) +
  scale_fill_viridis_c(option = "B")

ggplot(nyc.map.4boro) +
  geom_sf(aes(fill = BoroName)) 


tract.cent_test <- tract.cent %>% 
  mutate(BoroName = str_replace(BoroName, c("queens|brooklyn"), "brkln_queens"))
test3 <- test2 %>% 
  mutate(borough = str_replace(borough, c("queens|brooklyn"), "brkln_queens"))

st_dist_calc <- function(centroid, stations, name) {
 
  centroid.df <- centroid %>% 
    select(BoroCT2010, BoroName)
  centroid.df$geometry <- NULL
  centroid.tbl <- centroid.df %>% 
    as_tibble()
  result <- centroid.tbl %>% 
    filter(BoroName == name) %>% 
    bind_cols(
      centroid %>% 
        filter(BoroName == name) %>% 
        st_distance(
          stations %>% 
          filter(borough == name)
          ) %>% 
        unclass() %>% 
        as_tibble()
    ) %>% 
    gather("station", "ft_dist", -c(BoroCT2010, BoroName)) %>% 
    group_by(BoroCT2010, BoroName) %>% 
    top_n(-5, ft_dist) %>% 
    mutate(mile_dist = ft_dist / 5280) %>% 
    summarise(
      mean5_all = mean(mile_dist),
      med5_all = median(mile_dist)
      ) %>% 
    ungroup()
  return(result)
}



man_dist_test2 <- st_dist_calc(tract.cent_test, test3, "manhattan")
bronx_dist_test2 <- st_dist_calc(tract.cent_test, test3, "bronx")
brkl_queen_dist_test2 <- st_dist_calc(tract.cent_test, test3, "brkln_queens")

all.equal(man_dist_test, man_dist_test2)
all.equal(bronx_dist_test, bronx_dist_test2)
all.equal(brkl_queen_dist_test %>% select(BoroCT2010, mean5_all:med5_all), brkl_queen_dist_test2 %>% select(BoroCT2010, mean5_all:med5_all))

all_dist_test2 <- man_dist_test2 %>% 
  bind_rows(bronx_dist_test2) %>% 
  bind_rows(brkl_queen_dist_test2)

all.equal(all_dist_test %>% select(BoroCT2010, mean5_all:med5_all), all_dist_test2 %>% select(BoroCT2010, mean5_all:med5_all))


st_dist_calc2 <- function(name, centroid, stations) {
 
  centroid.df <- centroid %>% 
    select(BoroCT2010, BoroName)
  centroid.df$geometry <- NULL
  centroid.tbl <- centroid.df %>% 
    as_tibble()
  result <- centroid.tbl %>% 
    filter(BoroName == name) %>% 
    bind_cols(
      centroid %>% 
        filter(BoroName == name) %>% 
        st_distance(
          stations %>% 
          filter(borough == name)
          ) %>% 
        unclass() %>% 
        as_tibble()
    ) %>% 
    gather("station", "ft_dist", -c(BoroCT2010, BoroName)) %>% 
    group_by(BoroCT2010, BoroName) %>% 
    top_n(-5, ft_dist) %>% 
    mutate(mile_dist = ft_dist / 5280) %>% 
    summarise(
      mean5 = mean(mile_dist),
      med5 = median(mile_dist),
      min1 = min(mile_dist)
      ) %>% 
    ungroup()
  return(result)
}


all_stations_list <-  map_dfr(c("manhattan", "bronx", "brkln_queens"), ~ st_dist_calc2(., tract.cent_test, test3))
ada_stations_list <- map_dfr(c("manhattan", "bronx", "brkln_queens"), ~ st_dist_calc2(., tract.cent_test, test3 %>% filter(ada)))





ada_stations_list %>% 
  gather("measure", "distance", mean5:med5) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 50) +
  facet_wrap(~ measure)
ada_stations_list %>% 
  ggplot(aes(mean5, med5)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, alpha = 0.5, color = "slategrey", size = 2)
all_stations_list %>% 
  gather("measure", "distance", mean5:med5) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 50) +
  facet_wrap(~ measure)
all_stations_list %>% 
  ggplot(aes(mean5, med5)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, alpha = 0.5, color = "slategrey", size = 2)


nyc.map.4boro %>% 
  inner_join(all_stations_list, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean5)) +
  scale_fill_viridis_c(option = "D")
nyc.map.4boro %>% 
  inner_join(ada_stations_list, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean5)) +
  scale_fill_viridis_c(option = "D")
nyc.map.4boro %>% 
  inner_join(ada_stations_list, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med5)) +
  scale_fill_viridis_c(option = "D")

all_stations_list %>% 
  ggplot(aes(min1)) +
  geom_histogram(bins = 50)
ada_stations_list %>% 
  ggplot(aes(min1)) +
  geom_histogram(bins = 50)
nyc.map.4boro %>% 
  inner_join(all_stations_list, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = min1)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(ada_stations_list, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = min1)) +
  scale_fill_viridis_c(option = "B")
```


```{r}
diff_stations <- all_stations_list %>% 
  inner_join(ada_stations_list %>% select(-BoroName), by = "BoroCT2010", suffix = c("_all", "_ada")) %>% 
  mutate(
    mean_diff = mean5_ada - mean5_all,
    med_diff = med5_ada - med5_all,
    min_diff = min1_ada - min1_all
  )
diff_stations %>% 
  select(-c(mean5_all:min1_ada)) %>% 
  gather("measure", "distance", mean_diff:min_diff) %>% 
  ggplot(aes(distance, fill = measure)) +
  geom_histogram(bins = 50) +
  facet_wrap(~ measure)
nyc.map.4boro %>% 
  inner_join(diff_stations, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = med_diff)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(diff_stations, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = mean_diff)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(diff_stations, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = min_diff)) +
  scale_fill_viridis_c(option = "B")
nyc.map.4boro %>% 
  inner_join(diff_stations, by = "BoroCT2010") %>% 
  ggplot() +
  geom_sf(aes(fill = min_diff)) +
  scale_fill_viridis_c(option = "B")
```











The ratio normalization doesn't really work so well, the subtraction is probably the better choice in this case.

Next steps:
- Separate distance calculations by borough for both the random point and the station, in case "closest" stations are across a river. Probably can keep Queens and Brooklyn together?
- Incorporate outage data to find the "true" dead zones? Or areas that are usually suffering from long-term outages of accessibility equipment?
- Find a better NYC map overlay - is it the 311 long,lat data that's the problem, or the map I got from ggmap? 


```{r, eval = FALSE}
test.map <- readOGR("./data/nyct2010_18a", "nyct2010")
tm_shape(test.map) +
  tm_borders() 
test.map2 <- fortify(test.map)
ggplot(test.map2, aes(x = long, y = lat, group = group)) +
  geom_polygon(fill = NA, color = "black")
test.map3 <- test.map[test.map$BoroName != "Staten Island", ]
tm_shape(test.map3) +
  tm_borders() 
dist.points <- SpatialPoints(dist.merge[, c(4, 3)])
proj4string(dist.points) <- CRS("+init=epsg:4326")
#proj4string(dist.points) <- CRS("+proj=lcc +lat_1=41.03333333333333 +lat_2=40.66666666666666 +lat_0=40.16666666666666 +lon_0=-74 +x_0=300000.0000000001 +y_0=0 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs")
plot(dist.points)
dist.points <- spTransform(dist.points, proj4string(test.map3))
dist.by.tract <- over(dist.points, test.map3)
dist.by.tract.frt <- fortify(dist.by.tract)
test4 <- dist.merge %>% 
  bind_cols(dist.by.tract.frt)
test5 <- test4 %>% 
  group_by(CT2010) %>% 
  summarize(avg_to_ada_stat = mean(top5.any.vs.ada.mean.dist))
test6 <- test4 %>% 
  group_by(NTAName) %>% 
  summarize(avg_to_ada_stat = mean(top5.any.vs.ada.mean.dist)) %>% 
  arrange(desc(avg_to_ada_stat))
merge.to.map <- merge(test.map3, test5, by.x = "CT2010", by.y = "CT2010")
merge.to.map2 <- merge.to.map
merge.to.map2[str_detect(merge.to.map2$NTAName, "park-cemetery-etc") | str_detect(merge.to.map2$NTAName, "Airport"), ] <- NA
tm_shape(merge.to.map2) +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "A"))
tm_shape(merge.to.map2) +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "B"))
tm_shape(merge.to.map2) +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "C"))
tm_shape(merge.to.map2) +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "D"))
tm_shape(merge.to.map2) +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "E"))
tm_shape(merge.to.map2) +
  tm_borders() +
  tm_fill("avg_to_ada_stat", style = "fixed", breaks = c(0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 3, 5.9643), palette = viridis(n = 8, option = "A"))
merge.to.map.neigh <- merge(test.map3, test6, by.x = "NTAName", by.y = "NTAName")
merge.to.map.neigh[str_detect(merge.to.map.neigh$NTAName, "park-cemetery-etc") | str_detect(merge.to.map.neigh$NTAName, "Airport"), ] <- NA
tm_shape(merge.to.map.neigh) +
  tm_borders()+
  tm_fill("avg_to_ada_stat", midpoint = NA, palette = viridis(n = 6, option = "A"))

sum(str_detect(merge.to.map$NTAName, "park-cemetery-etc"))
merge.parks <- merge.to.map[str_detect(merge.to.map$NTAName, "park-cemetery-etc"),]
tm_shape(merge.parks) +
  tm_fill()
```